<!DOCTYPE html>
<html lang="ka">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekge Admin â€” University Platform</title>
<link rel="icon" href="https://raw.githubusercontent.com/WEEKGE/live/refs/heads/main/logo/weekge%20logo%20admin.png">

<!-- SEO META -->
<meta name="description" content="Weekge Admin Panel â€” Manage university syllabus subjects, weeks, slides and videos.">
<meta name="keywords" content="weekge, week, weekge admin, syllabus editor, study admin, ug, university admin">
<meta name="author" content="weekge">
<meta name="theme-color" content="#0B1216">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@100..900&display=swap');

:root{
  --bg:#000000; --surface:#202020; --surface2:#161616; --text:#EDEFF2;
  --accent:#16b438; --success:#38d98a; --danger:#f12525;
  --buttontext:#ffffff;--field:#313131;
}

/* Scrollbar */
::-webkit-scrollbar{width:.35rem}
::-webkit-scrollbar-thumb{background:#16b438}

/* Base */
*{box-sizing:border-box;margin:0;padding:0;font-family: "Noto Sans Georgian", sans-serif;}
body{background:var(--bg);color:var(--text);height:100vh;display:grid;grid-template-rows:64px 1fr;overflow:hidden;}

  /* === Loading Overlay === */
  #loadingOverlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: #0B1216;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity .3s ease, visibility .3s ease;
  }
  #loadingOverlay.hidden {
    opacity: 0;
    visibility: hidden;
  }
  #loadingOverlay .spinner {
    width: 100px;
    height: 100px;
    border: 10px solid rgba(255,255,255,.15);
    border-top: 10px solid var(--accent);
    border-radius: 50%;
    animation: spin 0.3s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loadingOverlay p {
    margin-top: 16px;
    opacity: .9;
  }

/* Header */
header{background:var(--surface);display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid #0006;}
header h1{font-size:1.8rem;color:var(--accent);font-weight:700;pointer-events: none;user-select: none;}
header .right{display:flex;align-items:center;gap:12px;}
header button{transition: ease 0.1s;background:var(--accent);color:var(--buttontext);border:none;padding:8px 16px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;border-radius:0;}
header button img{width:18px;height:18px;filter:brightness(0) invert(1);}
header button:hover{background-color: var(--accent);}
#saveStatus{font-weight:600;font-size:18px; margin-right:30px;pointer-events: none;user-select: none;}
#saveStatus.saving{color:#ffc423}
#saveStatus.saved{color:var(--success);}
#saveStatus.error{color:var(--danger);}

/* Layout (dual scroll) */
main{display:grid;grid-template-columns:320px 1fr;height:calc(100vh - 60px);}
aside{background:#131313;border-right:1px solid #0006;display:flex;flex-direction:column;}
#sidebarScroll{flex:1;overflow-y:auto;padding:10px;}
section{overflow-y:auto;height:100%;padding:50px;}

/* Sidebar */
.search{width:100%;padding:10px;border:none;background:var(--surface);color:#fff;margin-bottom:10px;}
.subject-item{user-select: none;padding:10px;background:#ffffff18;border:1px solid #0006;margin-bottom:8px;cursor:pointer;font-weight:600; transition: ease-out 0.1s;}
.subject-item:hover{background:#ffffff22;}
.subject-item.active{background:#ffffff30;color:#ffffff;}
.btn-row{display:flex;gap:10px;margin-top:10px;padding:10px;}
.btn-row button{flex:1;padding:10px;background:var(--accent);color:#ffffff;border:none;cursor:pointer;font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px;}
.btn-row button img{width:20px;height:20px}


/* Editor */
#editor{transition:opacity .1s ease, filter .1s ease;}
#editor.fadeout{opacity:0;filter:blur(4px);}
#editor h2{font-size:1.2rem;margin-bottom:10px;color:var(--accent);}
label{display:block;font-weight:700;margin:8px 0 4px;}
input,select{width:100%;padding:10px;border:none;background:var(--field);color:var(--buttontext);font-size:1rem;margin-bottom:10px;}
.week{border:1px solid #0006;background:#141414;padding:18px;margin-bottom:44px;}
.week h3{margin-bottom:1rem;color:var(--accent);font-size: 1.5rem;}
.addBtn{transition: 0.2s ease;font-size: 1rem;background:var(--accent);color:var(--buttontext);border:none;padding:10px 20px;cursor:pointer;margin-top:8px;display:inline-flex;align-items:center;gap:6px;}
.addBtn:hover{background-color: #14862d;}


.success{background:var(--success);color:var(--buttontext)}
.danger{background:var(--danger);color:var(--buttontext);padding: 20px 0;}
.status{text-align:center;margin-top:10px;}
.global{border:0;background:#141414;padding:20px;margin: 40px 0;}
.global h3{color:var(--success);margin-bottom:6px;}

/* Color selector */
.colorPalette{display:flex;gap:15px;align-items:center;margin-left:6px;}


.colorBox{width:35px;height:35px;border:0;cursor:pointer;transition:.2s ease;filter:brightness(.95);border:rgba(255,255,255,0) 2px solid}
.colorBox[data-color="yellow"]{background:#ffb20b;}
.colorBox[data-color="green"]{background:#9eff1f;}
.colorBox[data-color="red"]{background:#ff1f1f;}
.colorBox[data-color="blue"]{background:#1168ff;}
.colorBox.active{border-radius:5px;filter:brightness(1.2);border:rgba(255,255,255,.75) 2px solid;box-sizing:border-box;}

/* Popup (Create Subject) */
#addPopup{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:2000;}
#addPopup.active{display:flex;animation:popupIn .18s ease;}
@keyframes popupIn{from{opacity:0;filter: blur(20px);}to{opacity:1;}}
.popup-box{background:#121A1F;border:1px solid #0006;width:min(92vw,420px);padding:18px 16px;border-radius:0px;box-shadow:0 10px 40px rgba(0,0,0,.5);}
.popup-box h3{color:var(--accent);margin-bottom:10px;text-align:center;}
.popup-box .row{display:grid;gap:6px;margin:8px 0;}
.popup-box input{width:100%;padding:10px;border:none;background:#23343B;color:#fff;}
.popup-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}
.popup-actions button{padding:10px;border:none;font-weight:800;cursor:pointer}
.createBtn{background:var(--accent);color:#ffffff}
.cancelBtn{background:#333;color:#fff}


.removeBtn {
  background: #e61717;
  color: #fff;
  border: none;
  padding: 8px 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0;
  transition: 0.2s ease;
  margin-top: 20px;
  margin-bottom: 30px;
  font-weight: 500;
  font-size: 1rem;
  width: fit-content;
}

.removeBtn:hover {
  background: #920c0c;
}

.removeBtn img {
  width: 18px;
  height: 18px;
  filter: invert(1);
  pointer-events: none;
}
.topicField {
  width: 100%;
  min-height: 100px;
  max-height: 300px;
  overflow-y: auto;
  background: var(--field);
  color: var(--buttontext);
  padding: 10px;
  font-size: 1rem;
  border: none;
  outline: none;
  white-space: pre-wrap;
  word-wrap: break-word;
  line-height: 1.5;
  border-radius: 4px;
}
.topicField:focus {
  background: #303840;
}
.delete-progress {
  position:absolute;
  left:0;
  top:0;
  width:0%;
  height:100%;
  background-color:rgb(185, 0, 0);
  pointer-events:none;
  transition:none;
  z-index: -1;
}

#deleteNavBtn{background-color: #ff2e2e;transition: 0.1 ease;user-select: none;}
#deleteNavBtn:hover{transform: scale(1.02);}

#logoutBtn{background-color: #383838;transition: 0.1 ease;user-select: none;}
#logoutBtn:hover{transform: scale(1.02);}


#applyNavBtn{background-color: #47da1a;transition: 0.1 ease;user-select: none;}
#applyNavBtn:hover{transform: scale(1.02);}

.topicField{width:100%;min-height:100px;max-height:300px;overflow-y:auto;background:var(--field);color:var(--buttontext);padding:10px;font-size:1rem;border:none;outline:none;white-space:pre-wrap;word-wrap:break-word;line-height:1.5;border-radius:4px;}
.topicField:focus{background:#303840;}

/* Mobile */
@media(max-width:900px){
  main{grid-template-columns:1fr}
  aside{order:2}
  section{order:1;padding:18px}
  .customBtnRow{grid-template-columns:1fr 1fr auto;gap:8px}
  .colorPalette{grid-column:1 / -1}
}
</style>
</head>
<body>

<!-- Loading -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <p>áƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ...</p>
</div>

<header>
  <h1>Weekge Admin</h1>
  <div class="right">
    <div id="saveStatus" class="saved">âœ… áƒ“áƒáƒ›áƒáƒ®áƒ¡áƒáƒ•áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ</div>

    <!-- NAV: Apply / Delete -->
    <button id="applyNavBtn" title="Ctrl + S">
      <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/check.svg" alt="">Apply
    </button>
    <button id="deleteNavBtn">
      <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/delete.svg" alt="">Delete
    </button>

    <!-- Auth -->
    <button id="signinBtn">
      <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/check.svg" alt="">Google-áƒ˜áƒ— áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ
    </button>
    <button id="logoutBtn" style="display:none;">
      <img src="https://github.com/WEEKGE/live/raw/refs/heads/main/svgs/logout.svg" alt="">áƒ’áƒáƒ¡áƒ•áƒšáƒ
    </button>
  </div>
</header>

<main>
  <aside>
    <div id="sidebarScroll">
      <input type="search" id="searchBox" class="search" placeholder="áƒ›áƒáƒ«áƒ”áƒ‘áƒœáƒ">
      <div id="subjectList"></div>
    </div>
    <div class="btn-row">
      <button id="addSubjectBtn">
        <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" alt="">áƒ¡áƒáƒ’áƒœáƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ
      </button>
    </div>
  </aside>

  <section>
    <h2 id="editorTitle">áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒáƒ’áƒáƒœáƒ˜ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ™áƒ”áƒ—áƒ”áƒ‘áƒšáƒáƒ“</h2>
    <div id="editor" style="display:none;">
      <label>áƒ¡áƒáƒ’áƒœáƒ˜áƒ¡ ID</label>
      <input id="subjectId" disabled>
      <label>áƒ¡áƒáƒ’áƒœáƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜</label>
      <input id="subjectName">
      <label>áƒšáƒ”áƒ¥áƒªáƒ˜áƒ˜áƒ¡ áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜</label>
      <input id="subjectTheme">

      <div class="global">
        <h3>áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ áƒ”áƒ¡áƒ£áƒ áƒ¡áƒ”áƒ‘áƒ˜</h3>
        <div id="globalBtns"></div>
        <button class="addBtn" id="addGlobalBtn">
          <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" alt="" width="18" height="18">áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ áƒ”áƒ¡áƒ£áƒ áƒ¡áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ
        </button>
      </div>

      <div id="weeksContainer"></div>

      <!-- Optional local buttons kept (but not autosaving) -->
      <div class="btn-row" style="padding:0">
        <button class="success" id="saveBtn">
          <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/check.svg" alt="" width="18" height="18">Apply
        </button>
        <button class="danger" id="deleteBtn">
          <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/delete.svg" alt="" width="18" height="18">Delete
        </button>
      </div>
      <div class="status" id="status"></div>
    </div>
  </section>
</main>

<!-- Create Subject Popup -->
<div id="addPopup">
  <div class="popup-box">
    <h3>ğŸ†• áƒáƒ®áƒáƒšáƒ˜ áƒ¡áƒáƒ’áƒáƒœáƒ˜</h3>
    <div class="row">
      <label for="popupName">áƒ¡áƒáƒ’áƒœáƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜</label>
      <input id="popupName" placeholder="áƒ›áƒáƒ’: Microeconomics" />
    </div>
    <div class="row">
      <label for="popupId">ID</label>
      <input id="popupId" placeholder="ECON1234" />
    </div>
    <div class="popup-actions">
      <button class="cancelBtn" id="popupCancel">Cancel</button>
      <button class="createBtn" id="popupCreate">Create</button>
    </div>
  </div>
</div>

<script>
const overlay = document.getElementById("loadingOverlay");

/* === Firebase init from external config === */
fetch("https://raw.githubusercontent.com/WEEKGE/live/main/config.json")
  .then(r => r.json())
  .then(cfg => { 
    firebase.initializeApp(cfg); 
    startAdmin(); 
  })
  .catch(() => {
    document.body.innerHTML = "<h2 style='color:red;text-align:center;margin-top:30vh;'>âš ï¸ áƒ‘áƒáƒ–áƒ áƒ•áƒ”áƒ  áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ.</h2>";
  });

function startAdmin(){
  const auth = firebase.auth(), db = firebase.firestore();
  let user = null, subjects = [], currentId = null;
  let isDirty = false; // <- áƒáƒ£áƒ¢áƒáƒ¡áƒ”áƒ˜áƒ•áƒ˜áƒ¡ áƒœáƒáƒªáƒ•áƒšáƒáƒ“ áƒªáƒ•áƒšáƒ˜áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒœáƒ˜áƒ¢áƒáƒ áƒ˜

  const ADMIN_EMAILS = ["davit.gvakharia@gmail.com"];
  const $ = s => document.querySelector(s);
  const el = (t, p = {}, kids = []) => { const e = document.createElement(t); Object.assign(e, p); kids.forEach(k => e.append(k)); return e; };

  const saveStatus = $("#saveStatus");
  const statusBox = $("#status");

  const setSaveState = (state, msg) => {
    saveStatus.className = "";
    if(state === "wait"){
      saveStatus.textContent = "â³ áƒ›áƒáƒ˜áƒ—áƒ›áƒ˜áƒœáƒ”...";
      saveStatus.classList.add("wait");
    }else if(state === "saved"){
      saveStatus.textContent = "âœ… áƒ“áƒáƒ›áƒáƒ®áƒ¡áƒáƒ•áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ";
      saveStatus.classList.add("saved");
      isDirty = false;
    }else if(state === "error"){
      saveStatus.textContent = "âŒ áƒáƒ áƒáƒ‘áƒšáƒ”áƒ›áƒáƒ";
      saveStatus.classList.add("error");
    }else if(state === "dirty"){
      saveStatus.textContent = "âš ï¸ áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡";
      saveStatus.classList.add("dirty");
    }else{
      if(msg) saveStatus.textContent = msg;
    }
    if(msg && statusBox){ statusBox.textContent = msg; }
  };

  const markDirty = () => {
    isDirty = true;
    setSaveState("dirty");
  };

  function showToast(m, c = "#fff") {
    if (statusBox) { statusBox.textContent = m; statusBox.style.color = c; }
  }

  /* === Auth === */
  $("#signinBtn").onclick = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    overlay.querySelector("p").textContent = "áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ áƒ›áƒ˜áƒ›áƒ“áƒ˜áƒœáƒáƒ áƒ”áƒáƒ‘áƒ¡...";
    overlay.classList.remove("hidden");
    try{ await auth.signInWithPopup(provider); }
    catch(err){ console.error("Sign-in error:", err); alert("âŒ áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ˜áƒ¡áƒáƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒáƒ"); overlay.classList.add("hidden"); }
  };

  $("#logoutBtn").onclick = async () => {
    overlay.querySelector("p").textContent = "áƒ’áƒáƒ¡áƒ•áƒšáƒ...";
    overlay.classList.remove("hidden");
    try{ await auth.signOut(); }
    catch(err){ console.error("Logout error:", err); alert("âŒ áƒ’áƒáƒ¡áƒ•áƒšáƒ˜áƒ¡áƒáƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒáƒ"); overlay.classList.add("hidden"); }
  };

  auth.onAuthStateChanged(async u => {
    user = u || null;
    if(user){
      $("#signinBtn").style.display = "none";
      $("#logoutBtn").style.display = "inline-flex";

      if(ADMIN_EMAILS.includes(user.email)){
        await loadSubjects();
        overlay.querySelector("p").textContent = "áƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ...";
        setTimeout(() => overlay.classList.add("hidden"), 600);
      }else{
        overlay.innerHTML = "<h1 style='color:red;'>ğŸš« Access Denied</h1>";
      }
    }else{
      setTimeout(() => overlay.classList.add("hidden"), 600);
      $("#signinBtn").style.display = "inline-flex";
      $("#logoutBtn").style.display = "none";
    }
  });

  /* === Subjects === */
  async function loadSubjects(){
    const snap = await db.collection("subjects").get();
    subjects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderList();
  }

  function renderList(){
    const list = $("#subjectList"); 
    list.innerHTML = "";
    const q = $("#searchBox").value.toLowerCase();
    subjects
      .filter(s => (s.name||"").toLowerCase().includes(q) || (s.id||"").toLowerCase().includes(q))
      .forEach(s => {
        const div = el("div",{ className:"subject-item", textContent:`${s.name} (${s.id})` });
        div.onclick = () => openSubject(s.id);
        if(s.id === currentId) div.classList.add("active");
        list.append(div);
      });
  }
  $("#searchBox").oninput = renderList;

  /* === Popup create === */
  const popup = $("#addPopup");
  $("#addSubjectBtn").onclick = () => { 
    $("#popupName").value = ""; 
    $("#popupId").value = ""; 
    popup.classList.add("active"); 
    $("#popupName").focus(); 
  };
  $("#popupCancel").onclick = () => popup.classList.remove("active");
  $("#popupCreate").onclick = createSubject;
  $("#popupId").addEventListener("keydown", e => { if(e.key === "Enter") createSubject(); });

  async function createSubject(){
    const name = $("#popupName").value.trim();
    const id = $("#popupId").value.trim();
    if(!name || !id){ alert("áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ” áƒáƒ áƒ˜áƒ•áƒ” áƒ•áƒ”áƒšáƒ˜: áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ áƒ“áƒ ID"); return; }
    const valid = /^[a-z0-9\-_\.]+$/i.test(id);
    if(!valid){ alert("ID áƒ£áƒœáƒ“áƒ áƒ¨áƒ”áƒ˜áƒªáƒáƒ•áƒ“áƒ”áƒ¡ áƒ›áƒ®áƒáƒšáƒáƒ“ áƒáƒ¡áƒáƒ”áƒ‘áƒ¡, áƒªáƒ˜áƒ¤áƒ áƒ”áƒ‘áƒ¡, '-', '_' áƒáƒœ '.'"); return; }
    const doc = await db.collection("subjects").doc(id).get();
    if(doc.exists){ alert("áƒáƒ˜áƒ“áƒ˜ áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ. áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒ®áƒ•áƒ ID."); return; }

    const payload = { id, name, theme:"", globalButtons:[], weeks:[] };
    await db.collection("subjects").doc(id).set(payload);
    popup.classList.remove("active");
    await loadSubjects();
    openSubject(id);
    showToast("âœ… Subject created","#38d98a");
  }

  function fadeEditor(cb){
    const ed = $("#editor");
    ed.classList.add("fadeout");
    setTimeout(() => { cb(); ed.classList.remove("fadeout"); }, 120);
  }

  async function openSubject(id){
    const doc = await db.collection("subjects").doc(id).get();
    if(!doc.exists){ alert("Not found"); return; }
    const data = doc.data();
    currentId = id;
    isDirty = false;
    setSaveState("saved");

    document.querySelectorAll(".subject-item").forEach(x => 
      x.classList.toggle("active", x.textContent.endsWith(`(${id})`))
    );

    $("#editor").style.display = "block";
    fadeEditor(() => {
      $("#editorTitle").textContent = `Editing: ${data.name}`;
      $("#subjectId").value = id;
      $("#subjectName").value = data.name || "";
      $("#subjectTheme").value = data.theme || "";
      renderGlobal(data.globalButtons || []);
      renderWeeks(data.weeks || []);
    });
  }

  const COLOR_NAMES = ["yellow","red","blue","green"];

  function createButtonEditor(b){
    const wrap = el("div",{className:"customBtnRow"});
    const selected = b.colorName || "yellow";
    wrap.dataset.colorName = selected;
    wrap.innerHTML = `
      <input class="btnLabel" type="text" value="${b.label||""}" placeholder="áƒ¡áƒáƒ®áƒ”áƒšáƒ˜">
      <input class="btnLink" type="text" value="${b.link||""}" placeholder="áƒšáƒ˜áƒœáƒ™áƒ˜">
      <div class="colorPalette">
        ${COLOR_NAMES.map(c=>`<div class="colorBox ${c===selected?"active":""}" data-color="${c}"></div>`).join("")}
      </div>
      <button class="removeBtn" title="Remove">
        <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/delete.svg" alt="">
      </button>
    `;

    wrap.querySelectorAll(".btnLabel,.btnLink").forEach(inp=>{
      inp.addEventListener("input", markDirty);
    });

    wrap.querySelectorAll(".colorBox").forEach(box=>{
      box.onclick=()=>{
        wrap.querySelectorAll(".colorBox").forEach(bx=>bx.classList.remove("active"));
        box.classList.add("active");
        wrap.dataset.colorName = box.dataset.color;
        markDirty();
      };
    });

    wrap.querySelector(".removeBtn").onclick = () => { wrap.remove(); markDirty(); };
    return wrap;
  }

  function renderGlobal(btns){
    const box = $("#globalBtns"); box.innerHTML = "";
    btns.forEach(b => box.append(createButtonEditor(b)));
    $("#addGlobalBtn").onclick = () => {
      box.append(createButtonEditor({label:"New", link:"", colorName:"yellow"}));
      markDirty();
    };
  }

  function renderWeeks(weeks){
    const box = $("#weeksContainer"); box.innerHTML = "";
    for(let i=1;i<=12;i++){ // 12 áƒ™áƒ•áƒ˜áƒ áƒ
      const w = weeks.find(x=>x.week===i)||{};
      const div = el("div",{className:"week"});
      div.innerHTML = `
        <h3>áƒ™áƒ•áƒ˜áƒ áƒ ${i}</h3>
        <label>áƒ—áƒ”áƒ›áƒ˜áƒ¡ áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜</label>
        <div id="topic-${i}" class="topicField" contenteditable="true">${w.topic || ""}</div>

        <label style="margin-top:18px;">áƒšáƒ”áƒ¥áƒªáƒ˜áƒ˜áƒ¡ áƒ¢áƒ˜áƒáƒ˜</label>
        <select id="type-${i}" style="background:#23343B;color:var(--buttontext)">
          <option value="áƒšáƒ”áƒ¥áƒªáƒ˜áƒ"${w.type==="áƒšáƒ”áƒ¥áƒªáƒ˜áƒ"?" selected":""}>áƒšáƒ”áƒ¥áƒªáƒ˜áƒ</option>
          <option value="áƒšáƒ”áƒ¥áƒªáƒ˜áƒ (áƒ¥áƒ•áƒ˜áƒ–áƒ˜)"${w.type==="áƒšáƒ”áƒ¥áƒªáƒ˜áƒ (áƒ¥áƒ•áƒ˜áƒ–áƒ˜)"?" selected":""}>áƒšáƒ”áƒ¥áƒªáƒ˜áƒ (áƒ¥áƒ•áƒ˜áƒ–áƒ˜)</option>
          <option value="áƒ¨áƒ£áƒáƒšáƒ”áƒ“áƒ£áƒ áƒ˜"${w.type==="áƒ¨áƒ£áƒáƒšáƒ”áƒ“áƒ£áƒ áƒ˜"?" selected":""}>áƒ¨áƒ£áƒáƒšáƒ”áƒ“áƒ£áƒ áƒ˜</option>
        </select>

        <label style="margin-top:18px;">áƒ‘áƒ›áƒ£áƒšáƒ”áƒ‘áƒ˜</label>
        <div id="buttons-${i}"></div>

        <div class="weekBtns" id="weekBtns-${i}" style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="addBtn slideBtn" data-week="${i}" style="background-color:#e8980e;">
            <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" width="18" height="18" alt="">áƒ¡áƒšáƒáƒ˜áƒ“áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ
          </button>
          <button class="addBtn videoBtn" data-week="${i}" style="background-color:#eb1515;">
            <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" width="18" height="18" alt="">áƒ•áƒ˜áƒ“áƒ”áƒáƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ
          </button>
          <button class="addBtn addCustom" data-week="${i}" style="background-color:#323742;">
            <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" width="18" height="18" alt="">áƒ¡áƒ®áƒ•áƒ áƒ áƒ”áƒ¡áƒ£áƒ áƒ¡áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ
          </button>
        </div>
      `;
      box.append(div);

      const btnBox = div.querySelector(`#buttons-${i}`);
      (w.buttons||[]).forEach(b => btnBox.append(createButtonEditor(b)));

      const topicField = div.querySelector(`#topic-${i}`);
      topicField.addEventListener("input", markDirty);

      div.querySelector(`#type-${i}`).addEventListener("input", markDirty);

      div.querySelector(".slideBtn").onclick = () => {
        const exists = [...btnBox.querySelectorAll(".btnLabel")].some(el => el.value.trim().toLowerCase() === "áƒ¡áƒšáƒáƒ˜áƒ“áƒ˜" || el.value.trim().toLowerCase() === "slide");
        if(!exists){
          btnBox.append(createButtonEditor({label:"áƒ¡áƒšáƒáƒ˜áƒ“áƒ˜",link:"DRIVELINK/preview",colorName:"yellow"}));
          updateAddButtonsVisibility(i);
          markDirty();
        }
      };
      div.querySelector(".videoBtn").onclick = () => {
        const exists = [...btnBox.querySelectorAll(".btnLabel")].some(el => el.value.trim().toLowerCase() === "áƒ•áƒ˜áƒ“áƒ”áƒ" || el.value.trim().toLowerCase() === "video");
        if(!exists){
          btnBox.append(createButtonEditor({label:"áƒ•áƒ˜áƒ“áƒ”áƒ",link:"",colorName:"red"}));
          updateAddButtonsVisibility(i);
          markDirty();
        }
      };
      div.querySelector(".addCustom").onclick = () => {
        btnBox.append(createButtonEditor({label:"",link:"",colorName:"blue"}));
        markDirty();
      };

      updateAddButtonsVisibility(i);
    }
  }

  function updateAddButtonsVisibility(i){
    const weekBox = document.querySelector(`#buttons-${i}`);
    const slideBtn = document.querySelector(`#weekBtns-${i} .slideBtn`);
    const videoBtn = document.querySelector(`#weekBtns-${i} .videoBtn`);
    const hasSlide = [...weekBox.querySelectorAll(".btnLabel")].some(el=>el.value.trim().toLowerCase()==="áƒ¡áƒšáƒáƒ˜áƒ“áƒ˜" || el.value.trim().toLowerCase()==="slide");
    const hasVideo = [...weekBox.querySelectorAll(".btnLabel")].some(el=>el.value.trim().toLowerCase()==="áƒ•áƒ˜áƒ“áƒ”áƒ" || el.value.trim().toLowerCase()==="video");
    slideBtn.style.display = hasSlide ? "none" : "inline-flex";
    videoBtn.style.display = hasVideo ? "none" : "inline-flex";
  }

  /* === Collect and Save (manual) === */
  function collectForm(){
    if(!currentId) return null;

    const globalBtns=[...document.querySelectorAll("#globalBtns .customBtnRow")].map(b=>({
      label:b.querySelector(".btnLabel").value,
      link:b.querySelector(".btnLink").value,
      colorName:b.dataset.colorName
    }));

    const weeks=[];
    for(let i=1;i<=12;i++){
      const topic=(document.querySelector("#topic-"+i)?.innerHTML||"").trim();
      const type=(document.querySelector("#type-"+i)?.value)||"áƒšáƒ”áƒ¥áƒªáƒ˜áƒ";
      const weekDiv=document.querySelector("#buttons-"+i);
      const buttons=[...(weekDiv?.querySelectorAll(".customBtnRow")||[])].map(b=>({
        label:b.querySelector(".btnLabel").value,
        link:b.querySelector(".btnLink").value,
        colorName:b.dataset.colorName
      }));
      const w={week:i,type,buttons};
      if(topic) w.topic=topic;
      weeks.push(w);
    }

    const name=$("#subjectName").value.trim();
    const theme=$("#subjectTheme").value.trim();

    return { id: currentId, name, theme, globalButtons: globalBtns, weeks };
  }

  async function saveNow(){
    if(!currentId){ alert("áƒ¯áƒ”áƒ  áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒáƒ’áƒáƒœáƒ˜."); return; }
    const payload = collectForm();
    if(!payload) return;

    try{
      setSaveState("wait");
      await db.collection("subjects").doc(currentId).set(payload, { merge:true });
      setSaveState("saved");
      showToast("âœ… Changes saved","#38d98a");
      // áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ”áƒ¡ áƒ¡áƒ˜áƒ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜áƒ¡ áƒªáƒ•áƒšáƒ˜áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ—áƒ®áƒ•áƒ”áƒ•áƒáƒ¨áƒ˜
      const idx = subjects.findIndex(s => s.id === currentId);
      if(idx>-1){ subjects[idx] = {...subjects[idx], ...payload}; renderList(); }
    }catch(e){
      console.error(e);
      setSaveState("error");
      alert("âŒ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ˜áƒ¡áƒáƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒáƒ");
    }
  }

  async function deleteCurrent(){
    if(!currentId){ alert("áƒ¯áƒ”áƒ  áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒáƒ’áƒáƒœáƒ˜."); return; }
    if(!confirm("Delete this subject?")) return;
    try{
      setSaveState("wait");
      await db.collection("subjects").doc(currentId).delete();
      $("#editor").style.display="none";
      const removedId = currentId;
      currentId=null;
      await loadSubjects();
      setSaveState("saved");
      showToast("ğŸ—‘ï¸ Deleted","#ed3737");
      // áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜ highlight áƒ›áƒáƒ®áƒ“áƒ”áƒ¡
      document.querySelectorAll(".subject-item").forEach(x=>x.classList.remove("active"));
    }catch(e){
      console.error(e);
      setSaveState("error");
      alert("âŒ áƒ¬áƒáƒ¨áƒšáƒ˜áƒ¡áƒáƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒáƒ");
    }
  }

/* === Hold-to-Delete Delay Setup === */
  function addHoldToDelete(btn, action) {
    let progress = 0, interval;
    // create progress overlay if not exists
    let bar = btn.querySelector(".delete-progress");
    if (!bar) {
      bar = document.createElement("span");
      bar.className = "delete-progress";
      btn.prepend(bar);
    }

    btn.addEventListener("mousedown", () => {
      progress = 0;
      bar.style.width = "0%";
      interval = setInterval(() => {
        progress += 100 / 20; // fill over ~3s
        bar.style.width = progress + "%";
        if (progress >= 100) {
          clearInterval(interval);
          bar.style.width = "100%";
          action(); // perform delete
        }
      }, 50);
    });

    ["mouseup", "mouseleave"].forEach(ev => {
      btn.addEventListener(ev, () => {
        clearInterval(interval);
        bar.style.width = "0%";
      });
    });
  }

  /* === Wire buttons === */
  $("#saveBtn").onclick = saveNow;
  $("#applyNavBtn").onclick = saveNow;

  // replace direct delete click with hold-to-delete
  addHoldToDelete($("#deleteBtn"), deleteCurrent);
  addHoldToDelete($("#deleteNavBtn"), deleteCurrent);

  // áƒ•áƒ”áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒªáƒ•áƒšáƒ˜áƒšáƒ”áƒ‘áƒáƒ–áƒ” áƒ›áƒáƒœáƒ˜áƒ¨áƒ•áƒœáƒ dirty
  ["#subjectName","#subjectTheme"].forEach(sel=>{
    $(sel).addEventListener("input", markDirty);
  });

  // Ctrl+S => Apply
  document.addEventListener("keydown", (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="s"){
      e.preventDefault();
      saveNow();
    }
  });

  /* --- Formatting shortcuts (bold/italic/underline) --- */
  document.addEventListener("keydown", e => {
    if (e.ctrlKey && ["b","i","u"].includes(e.key.toLowerCase())) {
      e.preventDefault();
      const cmd = e.key.toLowerCase() === "b" ? "bold" :
                  e.key.toLowerCase() === "i" ? "italic" : "underline";
      document.execCommand(cmd, false, null);
      markDirty();
    }
  });
}
</script>

</body>
</html>
