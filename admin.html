<!DOCTYPE html>
<html lang="ka">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekge Admin ‚Äî University Platform</title>

<!-- SEO META -->
<meta name="description" content="Weekge Admin Panel ‚Äî Manage university syllabus subjects, weeks, slides and videos.">
<meta name="keywords" content="weekge, week, weekge admin, syllabus editor, study admin, ug, university admin">
<meta name="author" content="weekge">
<meta name="theme-color" content="#0B1216">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Saira:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg:#0B1216;
  --surface:#17333d;
  --card:#2A3A40;
  --text:#EDEFF2;
  --accent:#0fbe35;
  --success:#0fdf32;
  --danger:#ED3737;
  --shadow:0 8px 28px rgba(0,0,0,.35);
  --buttontext:#ffffff;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:"Saira",sans-serif;}
body{
  background:var(--bg);
  color:var(--text);
  height:100vh;
  display:grid;
  grid-template-rows:64px 1fr;
}
header{
  background:var(--surface);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
  border-bottom:1px solid #0006;
}
header h1{font-size:20px;color:var(--accent);font-weight:700;}
header button{
  background:var(--accent);
  color:#111;
  border:none;
  padding:8px 16px;
  font-weight:700;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:6px;
}
header button img{width:18px;height:18px;filter:brightness(0) invert(1);}
main{
  display:grid;
  grid-template-columns:320px 1fr;
  height:100%;
}
aside{
  background:#0E161A;
  border-right:1px solid #0006;
  overflow:auto;
  padding:10px;
}
section{overflow:auto;padding:20px;}
.search{
  width:100%;
  padding:10px;
  border:none;
  background:#23343B;
  color:#fff;
  margin-bottom:10px;
  border-radius:0;
}
.subject-item{
  padding:10px;background:#1A2328;border:1px solid #0006;margin-bottom:8px;
  cursor:pointer;font-weight:500;border-radius:0;
}
.subject-item:hover{background:#2A3A40;}
.subject-item.active{background:var(--accent);color:#111;}
.btn-row{display:flex;gap:10px;margin-top:10px;}
.btn-row button{
  flex:1;padding:10px;background:var(--accent);color:#111;border:none;
  cursor:pointer;font-weight:600;border-radius:0;
  display:flex;align-items:center;justify-content:center;gap:6px;
}
.btn-row button img{width:18px;height:18px;}
#editor h2{font-size:22px;margin-bottom:10px;color:var(--accent);}
label{display:block;font-weight:600;margin:8px 0 4px;}
input,select{
  width:100%;padding:8px;border:none;background:#1A2328;color:#fff;font-size:1rem;margin-bottom:6px;
  border-radius:0;
}
.week{border:1px solid #0006;background:#121A1F;padding:10px;margin-bottom:14px;border-radius:0;}
.week h3{margin-bottom:8px;color:var(--accent);}
.customBtnRow{display:flex;align-items:center;gap:6px;margin:6px 0;flex-wrap:wrap;}
.customBtnRow input[type=text]{flex:1;min-width:100px;background:#23343B;color:#fff;border:none;padding:6px;border-radius:0;}
.palette{display:flex;gap:4px;}
.colorCircle{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:13px;cursor:pointer;border:1px solid #00000055;}
.colorCircle:hover{filter:brightness(1.2);}
.removeBtn{background:var(--danger);color:#fff;border:none;padding:6px 10px;cursor:pointer;border-radius:0;display:flex;align-items:center;gap:0;}
.removeBtn img{width:14px;height:14px;filter:invert(1);color: var(--buttontext);}
.addBtn{background:var(--accent);color: var(--buttontext);border:none;padding:8px 12px;cursor:pointer;font-weight:400;margin-top:8px;border-radius:0;display:flex;align-items:center;gap:6px;}
.addBtn img{width:16px;height:16px;filter:invert(1);color: var(--buttontext);}
.success{background:var(--success);color:var(--buttontext);}
.danger{background:var(--danger);color:var(--buttontext);}
.status{text-align:center;margin-top:10px;}
.global{border: 0;background:#182025;padding:10px;margin-bottom:20px;border-radius:0;}
.global h3{color:var(--success);margin-bottom:6px;}

#logoutBtn{color: white; font-weight: 500; border-radius:0}

@media(max-width:900px){main{grid-template-columns:1fr;}aside{order:2;}section{order:1;}}
</style>
</head>
<body>

<header>
  <h1>Weekge Admin</h1>
  <div>
    <button id="signinBtn"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/check.svg" alt="">Sign in with Google</button>
    <button id="logoutBtn" style="display:none;"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/delete.svg" style="width:25px;height:25px;" alt="">Logout</button>
  </div>
</header>

<main>
  <aside>
    <input type="search" id="searchBox" class="search" placeholder="Search subjects...">
    <div id="subjectList"></div>
    <div class="btn-row">
      <button id="addSubjectBtn" style="color: var(--buttontext);font-weight: 600;">
        <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" style="width:25px;height:25px;" alt="">Add Subject
      </button>
    </div>
  </aside>

  <section>
    <h2 id="editorTitle">Select a subject to edit</h2>
    <div id="editor" style="display:none;">
      <label>Subject ID</label>
      <input id="subjectId" disabled>

      <label>Subject Name</label>
      <input id="subjectName">

      <label>Theme Title</label>
      <input id="subjectTheme">

      <div class="global">
        <h3>üåç Global Buttons</h3>
        <div id="globalBtns"></div>
        <button class="addBtn" id="addGlobalBtn"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" style="width:25px;height:25px;color: #fff;" alt="">Add Global Button</button>
      </div>

      <div id="weeksContainer"></div>

      <div class="btn-row">
        <button class="success" id="saveBtn"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/check.svg" style="width:25px;height:25px;color: #fff;" alt="">SAVE</button>
        <button class="danger" id="deleteBtn"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/delete.svg" style="width:25px;height:25px;color: #fff;" alt="">DELETE</button>
      </div>
      <div class="status" id="status"></div>
    </div>
  </section>
</main>

<script>
fetch("https://raw.githubusercontent.com/WEEKGE/live/main/config.json")
  .then(r => r.json())
  .then(cfg => { firebase.initializeApp(cfg); startAdmin(); })
  .catch(() => document.body.innerHTML = "<h2 style='color:red;text-align:center;margin-top:30vh;'>‚ö†Ô∏è Firebase config not loaded.</h2>");

function startAdmin() {
  const auth = firebase.auth(), db = firebase.firestore();
  let user = null, subjects = [], currentId = null;
  const ADMIN_EMAILS = ["davit.gvakharia@gmail.com"];
  const $ = s => document.querySelector(s);
  const el = (t, p = {}, kids = []) => { const e = document.createElement(t); Object.assign(e, p); kids.forEach(k => e.append(k)); return e; };
  function showStatus(m, c = "#fff") { const s = $("#status"); if (s) { s.textContent = m; s.style.color = c; } }

  const COLOR_PALETTE = [
    { bg: "#ffc423", text: "#111" },
    { bg: "#38d98a", text: "#111" },
    { bg: "#ed3737", text: "#fff" },
    { bg: "#2979ff", text: "#fff" }
  ];

  const provider = new firebase.auth.GoogleAuthProvider();
  $("#signinBtn").onclick = () => auth.signInWithPopup(provider);
  $("#logoutBtn").onclick = () => auth.signOut();

  auth.onAuthStateChanged(async u => {
    user = u || null;
    if (user) {
      $("#signinBtn").style.display = "none"; $("#logoutBtn").style.display = "inline-flex";
      if (ADMIN_EMAILS.includes(user.email)) { await loadSubjects(); }
      else document.body.innerHTML = "<h1 style='text-align:center;margin-top:30vh;color:red;'>Access Denied</h1>";
    } else { $("#signinBtn").style.display = "inline-flex"; $("#logoutBtn").style.display = "none"; }
  });

  async function loadSubjects() {
    const snap = await db.collection("subjects").get();
    subjects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderList();
    showStatus(`‚úÖ Loaded ${subjects.length} subjects`, "#38d98a");
  }

  function renderList() {
    const list = $("#subjectList"); list.innerHTML = "";
    const q = $("#searchBox").value.toLowerCase();
    subjects.filter(s => s.name?.toLowerCase().includes(q) || s.id?.toLowerCase().includes(q))
      .forEach(s => {
        const div = el("div", { className: "subject-item", textContent: `${s.name} (${s.id})` });
        div.onclick = () => openSubject(s.id);
        list.append(div);
      });
  }
  $("#searchBox").oninput = renderList;

  $("#addSubjectBtn").onclick = () => {
    currentId = null;
    $("#editor").style.display = "block";
    $("#editorTitle").textContent = "üÜï New Subject";
    $("#subjectId").value = "";
    $("#subjectName").value = "";
    $("#subjectTheme").value = "";
    renderWeeks([]);
    $("#globalBtns").innerHTML = "";
  };

  async function openSubject(id) {
    const doc = await db.collection("subjects").doc(id).get();
    if (!doc.exists) return alert("Not found");
    const data = doc.data();
    currentId = id;
    $("#editor").style.display = "block";
    $("#editorTitle").textContent = `Editing: ${data.name}`;
    $("#subjectId").value = id;
    $("#subjectName").value = data.name || "";
    $("#subjectTheme").value = data.theme || "";
    renderWeeks(data.weeks || []);
    renderGlobal(data.globalButtons || []);
  }

  function renderGlobal(btns) {
    const box = $("#globalBtns"); box.innerHTML = "";
    btns.forEach((b, j) => box.append(createButtonEditor(b, j, true)));
    $("#addGlobalBtn").onclick = () => box.append(createButtonEditor({ label: "Global", color: "#ffc423", textColor: "#fff", link: "" }, box.children.length, true));
  }

  function renderWeeks(weeks) {
    const box = $("#weeksContainer"); box.innerHTML = "";
    for (let i = 1; i <= 12; i++) {
      const w = weeks.find(x => x.week === i) || {};
      const div = el("div", { className: "week" });
      div.innerHTML = `
      <h3>Week ${i}</h3>
      <label>Topic Title</label>
      <input id="topic-${i}" type="text" value="${w.topic || ""}" placeholder="e.g. Microeconomics Basics">
      <label>Type</label>
      <select id="type-${i}">
        <option value="·Éö·Éî·É•·É™·Éò·Éê"${w.type === "·Éö·Éî·É•·É™·Éò·Éê" ? " selected" : ""}>·Éö·Éî·É•·É™·Éò·Éê</option>
        <option value="·Éö·Éî·É•·É™·Éò·Éê (·É•·Éï·Éò·Éñ·Éò)"${w.type === "·Éö·Éî·É•·É™·Éò·Éê (·É•·Éï·Éò·Éñ·Éò)" ? " selected" : ""}>·Éö·Éî·É•·É™·Éò·Éê (·É•·Éï·Éò·Éñ·Éò)</option>
        <option value="·É®·É£·Éê·Éö·Éî·Éì·É£·É†·Éò"${w.type === "·É®·É£·Éê·Éö·Éî·Éì·É£·É†·Éò" ? " selected" : ""}>·É®·É£·Éê·Éö·Éî·Éì·É£·É†·Éò</option>
      </select>
      <div id="buttons-${i}"></div>
      <div class="weekBtns" id="weekBtns-${i}">
        <button class="addBtn slideBtn" data-week="${i}"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" >Add Slide</button>
        <button class="addBtn videoBtn" data-week="${i}"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg">Add Video</button>
        <button class="addBtn addCustom" data-week="${i}"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg">Add Custom</button>
      </div>`;
      box.append(div);
      const btnBox = div.querySelector(`#buttons-${i}`);
      (w.buttons || []).forEach(b => btnBox.append(createButtonEditor(b, 0, false)));
      updateAddButtonsVisibility(i);
    }

    document.querySelectorAll(".slideBtn").forEach(btn => {
      btn.onclick = () => {
        const i = btn.dataset.week;
        const box = $("#buttons-" + i);
        if ([...box.querySelectorAll(".btnLabel")].some(el => el.value.toLowerCase() === "slide")) return;
        const slideBtn = { label: "Slide", link: "#", color: "#2979ff", textColor: "#fff" };
        box.append(createButtonEditor(slideBtn, 0, false));
        updateAddButtonsVisibility(i);
      };
    });

    document.querySelectorAll(".videoBtn").forEach(btn => {
      btn.onclick = () => {
        const i = btn.dataset.week;
        const box = $("#buttons-" + i);
        if ([...box.querySelectorAll(".btnLabel")].some(el => el.value.toLowerCase() === "video")) return;
        const vidBtn = { label: "Video", link: "#", color: "#ed3737", textColor: "#fff" };
        box.append(createButtonEditor(vidBtn, 0, false));
        updateAddButtonsVisibility(i);
      };
    });

    document.querySelectorAll(".addCustom").forEach(btn => {
      btn.onclick = () => {
        const i = btn.dataset.week;
        $("#buttons-" + i).append(createButtonEditor({ label: "New", color: "#ffc423", textColor: "#111", link: "" }, 0, false));
      };
    });
  }

  function updateAddButtonsVisibility(i) {
    const weekBox = $("#buttons-" + i);
    const slideBtn = $("#weekBtns-" + i + " .slideBtn");
    const videoBtn = $("#weekBtns-" + i + " .videoBtn");
    const hasSlide = [...weekBox.querySelectorAll(".btnLabel")].some(el => el.value.toLowerCase() === "slide");
    const hasVideo = [...weekBox.querySelectorAll(".btnLabel")].some(el => el.value.toLowerCase() === "video");
    slideBtn.style.display = hasSlide ? "none" : "inline-flex";
    videoBtn.style.display = hasVideo ? "none" : "inline-flex";
  }

  function createButtonEditor(b) {
    const wrap = el("div", { className: "customBtnRow" });
    wrap.innerHTML = `
      <input class="btnLabel" type="text" value="${b.label || ""}" placeholder="Name">
      <input class="btnLink" type="text" value="${b.link || ""}" placeholder="Link">
      <div class="palette">
        ${COLOR_PALETTE.map(col => `<div class="colorCircle" data-bg="${col.bg}" data-text="${col.text}" style="background:${col.bg};color:${col.text}">${b.color === col.bg ? "‚úì" : ""}</div>`).join("")}
      </div>
      <button class="removeBtn"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/delete.svg"></button>`;
    wrap.dataset.color = b.color || "#ffc423";
    wrap.dataset.textColor = b.textColor || "#111";
    wrap.querySelectorAll(".colorCircle").forEach(circ => {
      circ.onclick = () => {
        wrap.dataset.color = circ.dataset.bg;
        wrap.dataset.textColor = circ.dataset.text;
        wrap.querySelectorAll(".colorCircle").forEach(x => x.textContent = "");
        circ.textContent = "‚úì";
      };
    });
    wrap.querySelector(".removeBtn").onclick = () => {
      const parentWeek = wrap.closest(".week");
      wrap.remove();
      if (parentWeek) {
        const i = parentWeek.querySelector("h3").textContent.replace("Week ", "");
        updateAddButtonsVisibility(i);
      }
    };
    return wrap;
  }

  $("#saveBtn").onclick = async () => {
    const id = currentId || prompt("Enter Subject ID:"); if (!id) return;
    const name = $("#subjectName").value.trim();
    const theme = $("#subjectTheme").value.trim();
    const globalBtns = [...$("#globalBtns").querySelectorAll(".customBtnRow")].map(b => ({
      label: b.querySelector(".btnLabel").value, link: b.querySelector(".btnLink").value,
      color: b.dataset.color, textColor: b.dataset.textColor
    }));
    const weeks = [];
    for (let i = 1; i <= 12; i++) {
      const weekDiv = $("#weeksContainer").children[i - 1];
      const topic = $("#topic-" + i).value.trim();
      const type = $("#type-" + i).value;
      const buttons = [...weekDiv.querySelectorAll(".customBtnRow")].map(b => ({
        label: b.querySelector(".btnLabel").value, link: b.querySelector(".btnLink").value,
        color: b.dataset.color, textColor: b.dataset.textColor
      }));
      const weekObj = { week: i, type, buttons };
      if (topic) weekObj.topic = topic;
      weeks.push(weekObj);
    }
    await db.collection("subjects").doc(id).set({ id, name, theme, globalButtons: globalBtns, weeks });
    showStatus("‚úÖ Saved!", "#38d98a");
    await loadSubjects();
  };

  $("#deleteBtn").onclick = async () => {
    if (!currentId || !confirm("Delete this subject?")) return;
    await db.collection("subjects").doc(currentId).delete();
    showStatus("üóëÔ∏è Deleted", "#ed3737");
    $("#editor").style.display = "none";
    await loadSubjects();
  };
}
</script>

</body>
</html>
