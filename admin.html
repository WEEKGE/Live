<!DOCTYPE html>
<html lang="ka">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekge Admin â€” University Platform</title>

<!-- SEO META -->
<meta name="description" content="Weekge Admin Panel â€” Manage university syllabus subjects, weeks, slides and videos.">
<meta name="keywords" content="weekge, week, weekge admin, syllabus editor, study admin, ug, university admin">
<meta name="author" content="weekge">
<meta name="theme-color" content="#0B1216">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>

@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@100..900&display=swap');


:root{
  --bg:#0B1216; --surface:#17333d; --surface2:#121A1F; --text:#EDEFF2;
  --accent:#16b438; --success:#38d98a; --danger:#f12525;
  --buttontext:#ffffff;
}

/* Scrollbar */
::-webkit-scrollbar{width:.35rem}
::-webkit-scrollbar-thumb{background:#16b438}

/* Base */
*{box-sizing:border-box;margin:0;padding:0;font-family: "Noto Sans Georgian", sans-serif;}
body{background:var(--bg);color:var(--text);height:100vh;display:grid;grid-template-rows:64px 1fr;overflow:hidden;}

  /* === Loading Overlay === */
  #loadingOverlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: #0B1216;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity .3s ease, visibility .3s ease;
  }
  #loadingOverlay.hidden {
    opacity: 0;
    visibility: hidden;
  }
  #loadingOverlay .spinner {
    width: 100px;
    height: 100px;
    border: 10px solid rgba(255,255,255,.15);
    border-top: 10px solid var(--accent);
    border-radius: 50%;
    animation: spin 0.3s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loadingOverlay p {
    margin-top: 16px;
    opacity: .9;
  }

/* Header */
header{background:var(--surface);display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid #0006;}
header h1{font-size:20px;color:var(--accent);font-weight:700;}
header .right{display:flex;align-items:center;gap:12px;}
header button{transition: ease-out 0.1s;background:var(--accent);color:var(--buttontext);border:none;padding:8px 16px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;border-radius:0;}
header button img{width:18px;height:18px;filter:brightness(0) invert(1);}
header button:hover{background-color: #138d2d;}
#saveStatus{font-weight:600;font-size:18px; margin-right:30px;}
#saveStatus.saving{color:#ffc423}
#saveStatus.saved{color:var(--success)}
#saveStatus.error{color:var(--danger)}

/* Layout (dual scroll) */
main{display:grid;grid-template-columns:320px 1fr;height:calc(100vh - 64px);}
aside{background:#0E161A;border-right:1px solid #0006;display:flex;flex-direction:column;}
#sidebarScroll{flex:1;overflow-y:auto;padding:10px;}
section{overflow-y:auto;height:100%;padding:20px;}

/* Sidebar */
.search{width:100%;padding:10px;border:none;background:#23343B;color:#fff;margin-bottom:10px;}
.subject-item{padding:10px;background:#1A2328;border:1px solid #0006;margin-bottom:8px;cursor:pointer;font-weight:600; transition: ease-out 0.1s;}
.subject-item:hover{background:#2A3A40;}
.subject-item.active{background:var(--surface);color:#ffffff;}
.btn-row{display:flex;gap:10px;margin-top:10px;padding:10px;}
.btn-row button{flex:1;padding:10px;background:var(--accent);color:#ffffff;border:none;cursor:pointer;font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px;}
.btn-row button img{width:20px;height:20px}


/* Editor */
#editor{transition:opacity .1s ease, filter .1s ease;}
#editor.fadeout{opacity:0;filter:blur(4px);}
#editor h2{font-size:22px;margin-bottom:10px;color:var(--accent);}
label{display:block;font-weight:700;margin:8px 0 4px;}
input,select{width:100%;padding:10px;border:none;background:#1A2328;color:var(--buttontext);font-size:1rem;margin-bottom:10px;}
.week{border:1px solid #0006;background:#121A1F;padding:12px;margin-bottom:24px;}
.week h3{margin-bottom:8px;color:var(--accent);}
.addBtn{background:var(--accent);color:var(--buttontext);border:none;padding:8px 12px;cursor:pointer;margin-top:8px;display:inline-flex;align-items:center;gap:6px;}
.success{background:var(--success);color:var(--buttontext)}
.danger{background:var(--danger);color:var(--buttontext)}
.status{text-align:center;margin-top:10px;}
.global{border:0;background:#182025;padding:10px;margin:14px 0 20px;}
.global h3{color:var(--success);margin-bottom:6px;}

/* Color selector */
.colorPalette{display:flex;gap:15px;align-items:center;margin-left:6px;}


.colorBox{width:35px;height:35px;border: 0;cursor:pointer;transition:.3s ease;box-shadow:0}


.colorBox[data-color="yellow"]{background:#ffc423;}
.colorBox[data-color="green"]{background:#38d98a;}
.colorBox[data-color="red"]{background:#ed3737;}
.colorBox[data-color="blue"]{background:#2979ff;}
.colorBox.active{border-radius: 50%; filter:brightness(1.2); border: rgba(255, 255, 255, 0.445) solid 2px; box-sizing: border-box;}

/* Popup (Create Subject) */
#addPopup{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:2000;}
#addPopup.active{display:flex;animation:popupIn .18s ease;}
@keyframes popupIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
.popup-box{background:#121A1F;border:1px solid #0006;width:min(92vw,420px);padding:18px 16px;border-radius:0px;box-shadow:0 10px 40px rgba(0,0,0,.5);}
.popup-box h3{color:var(--accent);margin-bottom:10px;text-align:center;}
.popup-box .row{display:grid;gap:6px;margin:8px 0;}
.popup-box input{width:100%;padding:10px;border:none;background:#23343B;color:#fff;}
.popup-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}
.popup-actions button{padding:10px;border:none;font-weight:800;cursor:pointer}
.createBtn{background:var(--accent);color:#ffffff}
.cancelBtn{background:#333;color:#fff}

.removeBtn {
  background: #e61717;
  color: #fff;
  border: none;
  padding: 8px 13px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0;
  transition: 0.2s ease;
  margin-top: 20px;
  margin-bottom: 10px;
  font-weight: 700;
}

.removeBtn:hover {
  background: #920c0c;
}

.removeBtn img {
  width: 18px;
  height: 18px;
  filter: invert(1);
  pointer-events: none;
}


@media(max-width:900px){
  main{grid-template-columns:1fr}
  aside{order:2}
  section{order:1}
}
</style>
</head>
<body>

<!-- Loading -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <p>áƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ...</p>
</div>

<header>
  <h1>Weekge Admin</h1>
  <div class="right">
    <div id="saveStatus" class="saved">âœ… áƒ“áƒáƒ›áƒáƒ®áƒ¡áƒáƒ•áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ</div>
    <button id="signinBtn">
      <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/check.svg" alt="">Google-áƒ˜áƒ— áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ
    </button>
    <button id="logoutBtn" style="display:none;">
      <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/delete.svg" alt="">áƒ’áƒáƒ¡áƒ•áƒšáƒ
    </button>
  </div>
</header>

<main>
  <aside>
    <div id="sidebarScroll">
      <input type="search" id="searchBox" class="search" placeholder="áƒ›áƒáƒ«áƒ”áƒ‘áƒœáƒ">
      <div id="subjectList"></div>
    </div>
    <div class="btn-row">
      <button id="addSubjectBtn">
        <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" alt="">áƒ¡áƒáƒ’áƒœáƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ
      </button>
    </div>
  </aside>

  <section>
    <h2 id="editorTitle">áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒáƒ’áƒáƒœáƒ˜ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ™áƒ”áƒ—áƒ”áƒ‘áƒšáƒáƒ“</h2>
    <div id="editor" style="display:none;">
      <label>áƒ¡áƒáƒ’áƒœáƒ˜áƒ¡ ID</label>
      <input id="subjectId" disabled>
      <label>áƒ¡áƒáƒ’áƒœáƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜</label>
      <input id="subjectName">
      <label>áƒšáƒ”áƒ¥áƒªáƒ˜áƒ˜áƒ¡ áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜</label>
      <input id="subjectTheme">

      <div class="global">
        <h3>áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ áƒ”áƒ¡áƒ£áƒ áƒ¡áƒ”áƒ‘áƒ˜</h3>
        <div id="globalBtns"></div>
        <button class="addBtn" id="addGlobalBtn">
          <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" alt="" width="18" height="18">áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ áƒ”áƒ¡áƒ£áƒ áƒ¡áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ
        </button>
      </div>

      <div id="weeksContainer"></div>

      <div class="btn-row" style="padding:0">
        <button class="success" id="saveBtn">
          <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/check.svg" alt="" width="18" height="18">SAVE
        </button>
        <button class="danger" id="deleteBtn">
          <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/delete.svg" alt="" width="18" height="18">DELETE
        </button>
      </div>
      <div class="status" id="status"></div>
    </div>
  </section>
</main>

<!-- Create Subject Popup -->
<div id="addPopup">
  <div class="popup-box">
    <h3>ğŸ†• áƒáƒ®áƒáƒšáƒ˜ áƒ¡áƒáƒ’áƒáƒœáƒ˜</h3>
    <div class="row">
      <label for="popupName">áƒ¡áƒáƒ’áƒœáƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜*</label>
      <input id="popupName" placeholder="áƒ›áƒáƒ’: Microeconomics" />
    </div>
    <div class="row">
      <label for="popupId">ID (áƒšáƒáƒ—áƒ˜áƒœáƒ£áƒ áƒ˜, áƒ£áƒœáƒ˜áƒ™áƒáƒšáƒ£áƒ áƒ˜)*</label>
      <input id="popupId" placeholder="áƒ›áƒáƒ’: micro-101" />
    </div>
    <div class="popup-actions">
      <button class="cancelBtn" id="popupCancel">Cancel</button>
      <button class="createBtn" id="popupCreate">Create</button>
    </div>
  </div>
</div>

<script>
const overlay = document.getElementById("loadingOverlay");

fetch("https://raw.githubusercontent.com/WEEKGE/live/main/config.json")
  .then(r => r.json())
  .then(cfg => { firebase.initializeApp(cfg); startAdmin(); })
  .catch(() => document.body.innerHTML = "<h2 style='color:red;text-align:center;margin-top:30vh;'>âš ï¸ Firebase config not loaded.</h2>");

function startAdmin(){
  const auth = firebase.auth(), db = firebase.firestore();
  let user=null, subjects=[], currentId=null, saveTimer=null;
  const ADMIN_EMAILS=["davit.gvakharia@gmail.com"];
  const $ = s => document.querySelector(s);
  const el=(t,p={},kids=[])=>{const e=document.createElement(t);Object.assign(e,p);kids.forEach(k=>e.append(k));return e;};

  const saveStatus=$("#saveStatus");
  const setSaveState=(st)=>{
    saveStatus.className="";
    if(st==="saving"){saveStatus.textContent=" áƒ›áƒáƒ˜áƒ—áƒ›áƒ˜áƒœáƒ”...";saveStatus.classList.add("saving");}
    else if(st==="saved"){saveStatus.textContent="âœ… áƒ“áƒáƒ›áƒáƒ®áƒ¡áƒáƒ•áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ";saveStatus.classList.add("saved");}
    else{saveStatus.textContent="âŒ áƒáƒ áƒáƒ‘áƒšáƒ”áƒ›áƒáƒ";saveStatus.classList.add("error");}
  };

  function showToast(m,c="#fff"){const s=$("#status");if(s){s.textContent=m;s.style.color=c}}

  /* AUTH */
  const provider=new firebase.auth.GoogleAuthProvider();
  $("#signinBtn").onclick=()=>auth.signInWithPopup(provider);
  $("#logoutBtn").onclick=()=>auth.signOut();

  auth.onAuthStateChanged(async u=>{
    user=u||null;
    if(user){
      $("#signinBtn").style.display="none";$("#logoutBtn").style.display="inline-flex";
      if(ADMIN_EMAILS.includes(user.email)){await loadSubjects();overlay.classList.add("hidden");}
      else overlay.innerHTML="<h1 style='color:red;'>Access Denied</h1>";
    }else{
      overlay.classList.add("hidden");
      $("#signinBtn").style.display="inline-flex";$("#logoutBtn").style.display="none";
    }
  });

  /* LOAD SUBJECTS */
  async function loadSubjects(){
    const snap=await db.collection("subjects").get();
    subjects=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderList();
  }

  function renderList(){
    const list=$("#subjectList"); list.innerHTML="";
    const q=$("#searchBox").value.toLowerCase();
    subjects
      .filter(s=>s.name?.toLowerCase().includes(q)||s.id?.toLowerCase().includes(q))
      .forEach(s=>{
        const div=el("div",{className:"subject-item",textContent:`${s.name} (${s.id})`});
        div.onclick=()=>openSubject(s.id);
        if(s.id===currentId) div.classList.add("active");
        list.append(div);
      });
  }
  $("#searchBox").oninput=renderList;

  /* CREATE SUBJECT POPUP */
  const popup=$("#addPopup");
  $("#addSubjectBtn").onclick=()=>{ $("#popupName").value=""; $("#popupId").value=""; popup.classList.add("active"); $("#popupName").focus(); };
  $("#popupCancel").onclick=()=>popup.classList.remove("active");
  $("#popupCreate").onclick=createSubject;
  $("#popupId").addEventListener("keydown",e=>{ if(e.key==="Enter") createSubject(); });

  async function createSubject(){
    const name=$("#popupName").value.trim();
    const id=$("#popupId").value.trim();
    if(!name || !id){alert("áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ” áƒáƒ áƒ˜áƒ•áƒ” áƒ•áƒ”áƒšáƒ˜: áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ áƒ“áƒ ID");return;}
    const valid=/^[a-z0-9\-_\.]+$/i.test(id);
    if(!valid){alert("ID áƒ£áƒœáƒ“áƒ áƒ¨áƒ”áƒ˜áƒªáƒáƒ•áƒ“áƒ”áƒ¡ áƒ›áƒ®áƒáƒšáƒáƒ“ áƒáƒ¡áƒáƒ”áƒ‘áƒ¡, áƒªáƒ˜áƒ¤áƒ áƒ”áƒ‘áƒ¡, '-', '_' áƒáƒœ '.'");return;}
    const doc=await db.collection("subjects").doc(id).get();
    if(doc.exists){alert("áƒáƒ˜áƒ“áƒ˜ áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ. áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒ®áƒ•áƒ ID.");return;}

    const payload={ id, name, theme:"", globalButtons:[], weeks:[] };
    await db.collection("subjects").doc(id).set(payload);
    popup.classList.remove("active");
    await loadSubjects();
    openSubject(id);
    showToast("âœ… Subject created", "#38d98a");
  }

  function fadeEditor(cb){
    const ed=$("#editor");
    ed.classList.add("fadeout");
    setTimeout(()=>{ cb(); ed.classList.remove("fadeout"); }, 100);
  }

  async function openSubject(id){
    const doc=await db.collection("subjects").doc(id).get();
    if(!doc.exists) return alert("Not found");
    const data=doc.data();
    currentId=id;
    document.querySelectorAll(".subject-item").forEach(x=>x.classList.toggle("active", x.textContent.endsWith(`(${id})`)));

    $("#editor").style.display="block";
    fadeEditor(()=>{
      $("#editorTitle").textContent=`Editing: ${data.name}`;
      $("#subjectId").value=id;
      $("#subjectName").value=data.name||"";
      $("#subjectTheme").value=data.theme||"";
      renderGlobal(data.globalButtons||[]);
      renderWeeks(data.weeks||[]);
    });
  }

  const COLOR_NAMES = ["blue","green","yellow","red"];

  function createButtonEditor(b){
    const wrap=el("div",{className:"customBtnRow"});
    const selected=b.colorName||"yellow";
    wrap.innerHTML=`
      <input class="btnLabel" type="text" value="${b.label||""}" placeholder="Name">
      <input class="btnLink" type="text" value="${b.link||""}" placeholder="Link">
      <div class="colorPalette">
        ${COLOR_NAMES.map(c=>`<div class="colorBox ${c===selected?"active":""}" data-color="${c}"></div>`).join("")}
      </div>
      <button class="removeBtn">áƒ¬áƒáƒ¨áƒšáƒ</button>
    `;
    wrap.dataset.colorName=selected;

    wrap.querySelectorAll(".colorBox").forEach(box=>{
      box.onclick=()=>{
        wrap.querySelectorAll(".colorBox").forEach(bx=>bx.classList.remove("active"));
        box.classList.add("active");
        wrap.dataset.colorName=box.dataset.color;
        autoSave();
      };
    });

    wrap.querySelector(".removeBtn").onclick=()=>{wrap.remove();autoSave();};
    return wrap;
  }

  function renderGlobal(btns){
    const box=$("#globalBtns"); box.innerHTML="";
    btns.forEach(b=> box.append(createButtonEditor(b)));
    $("#addGlobalBtn").onclick=()=>{
      box.append(createButtonEditor({label:"New", link:"", colorName:"yellow"}));
      autoSave();
    };
    box.oninput=autoSave;
  }

  function renderWeeks(weeks){
    const box=$("#weeksContainer"); box.innerHTML="";
    for(let i=1;i<=12;i++){
      const w=weeks.find(x=>x.week===i)||{};
      const div=el("div",{className:"week"});
      div.innerHTML=`
        <h3>áƒ™áƒ•áƒ˜áƒ áƒ ${i}</h3>
        <label>áƒ—áƒ”áƒ›áƒ˜áƒ¡ áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜</label>
        <input id="topic-${i}" type="text" value="${w.topic||""}">
        <label>áƒšáƒ”áƒ¥áƒªáƒ˜áƒ˜áƒ¡ áƒ¢áƒ˜áƒáƒ˜</label>
        <select id="type-${i}">
          <option value="áƒšáƒ”áƒ¥áƒªáƒ˜áƒ"${w.type==="áƒšáƒ”áƒ¥áƒªáƒ˜áƒ"?" selected":""}>áƒšáƒ”áƒ¥áƒªáƒ˜áƒ</option>
          <option value="áƒšáƒ”áƒ¥áƒªáƒ˜áƒ (áƒ¥áƒ•áƒ˜áƒ–áƒ˜)"${w.type==="áƒšáƒ”áƒ¥áƒªáƒ˜áƒ (áƒ¥áƒ•áƒ˜áƒ–áƒ˜)"?" selected":""}>áƒšáƒ”áƒ¥áƒªáƒ˜áƒ (áƒ¥áƒ•áƒ˜áƒ–áƒ˜)</option>
          <option value="áƒ¨áƒ£áƒáƒšáƒ”áƒ“áƒ£áƒ áƒ˜"${w.type==="áƒ¨áƒ£áƒáƒšáƒ”áƒ“áƒ£áƒ áƒ˜"?" selected":""}>áƒ¨áƒ£áƒáƒšáƒ”áƒ“áƒ£áƒ áƒ˜</option>
        </select>
        <div id="buttons-${i}"></div>
        <div class="weekBtns" id="weekBtns-${i}" style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="addBtn slideBtn" data-week="${i}" style="background-color:#e8980e; "><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" alt="" width="18" height="18">áƒ¡áƒšáƒáƒ˜áƒ“áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
          <button class="addBtn videoBtn" data-week="${i}" style="background-color:#eb1515; ""><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" alt="" width="18" height="18">áƒ•áƒ˜áƒ“áƒ”áƒáƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
          <button class="addBtn addCustom" data-week="${i}" style="background-color:#323742; ""><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" alt="" width="18" height="18">áƒ¡áƒ®áƒ•áƒ áƒ áƒ”áƒ¡áƒ£áƒ áƒ¡áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
        </div>
      `;
      box.append(div);

      const btnBox = div.querySelector(`#buttons-${i}`);
      (w.buttons||[]).forEach(b=> btnBox.append(createButtonEditor(b)));

      div.querySelector(`#topic-${i}`).oninput=autoSave;
      div.querySelector(`#type-${i}`).oninput=autoSave;

      div.querySelector(".slideBtn").onclick=()=>{
        const exists=[...btnBox.querySelectorAll(".btnLabel")].some(el=>el.value.toLowerCase()==="slide");
        if(!exists){ btnBox.append(createButtonEditor({label:"áƒ¡áƒšáƒáƒ˜áƒ“áƒ˜",link:"",colorName:"yellow"})); updateAddButtonsVisibility(i); autoSave(); }
      };
      div.querySelector(".videoBtn").onclick=()=>{
        const exists=[...btnBox.querySelectorAll(".btnLabel")].some(el=>el.value.toLowerCase()==="video");
        if(!exists){ btnBox.append(createButtonEditor({label:"áƒ•áƒ˜áƒ“áƒ”áƒ",link:"",colorName:"red"})); updateAddButtonsVisibility(i); autoSave(); }
      };
      div.querySelector(".addCustom").onclick=()=>{
        btnBox.append(createButtonEditor({label:"áƒ áƒ”áƒ¡áƒ£áƒ áƒ¡áƒ˜áƒ¡ áƒ“áƒáƒ¡áƒáƒ®áƒ”áƒšáƒ”áƒ‘áƒ",link:"",colorName:"blue"}));
        autoSave();
      };

      btnBox.oninput=autoSave;
      updateAddButtonsVisibility(i);
    }
  }

  function updateAddButtonsVisibility(i){
    const weekBox = document.querySelector(`#buttons-${i}`);
    const slideBtn = document.querySelector(`#weekBtns-${i} .slideBtn`);
    const videoBtn = document.querySelector(`#weekBtns-${i} .videoBtn`);
    const hasSlide = [...weekBox.querySelectorAll(".btnLabel")].some(el=>el.value.toLowerCase()==="slide");
    const hasVideo = [...weekBox.querySelectorAll(".btnLabel")].some(el=>el.value.toLowerCase()==="video");
    slideBtn.style.display = hasSlide ? "none" : "inline-flex";
    videoBtn.style.display = hasVideo ? "none" : "inline-flex";
  }

  async function autoSave(){
    if(!currentId) return;
    clearTimeout(saveTimer);
    setSaveState("saving");
    saveTimer=setTimeout(async()=>{
      try{
        const globalBtns=[...document.querySelectorAll("#globalBtns .customBtnRow")].map(b=>({
          label:b.querySelector(".btnLabel").value,
          link:b.querySelector(".btnLink").value,
          colorName:b.dataset.colorName
        }));
        const weeks=[];
        for(let i=1;i<=12;i++){
          const weekDiv=document.querySelector("#weeksContainer").children[i-1];
          if(!weekDiv) continue;
          const topic=(document.querySelector("#topic-"+i)?.value||"").trim();
          const type=(document.querySelector("#type-"+i)?.value)||"áƒšáƒ”áƒ¥áƒªáƒ˜áƒ";
          const buttons=[...weekDiv.querySelectorAll(".customBtnRow")].map(b=>({
            label:b.querySelector(".btnLabel").value,
            link:b.querySelector(".btnLink").value,
            colorName:b.dataset.colorName
          }));
          const w={week:i,type,buttons};
          if(topic) w.topic=topic;
          weeks.push(w);
        }
        const name=$("#subjectName").value.trim();
        const theme=$("#subjectTheme").value.trim();
        await db.collection("subjects").doc(currentId).set({ id:currentId, name, theme, globalButtons:globalBtns, weeks }, { merge:true });
        setSaveState("saved");
      }catch(e){console.error(e);setSaveState("error");}
    },1000);
  }

  $("#subjectName").oninput=autoSave;
  $("#subjectTheme").oninput=autoSave;
  $("#saveBtn").onclick=autoSave;
  $("#deleteBtn").onclick=async()=>{
    if(!currentId || !confirm("Delete this subject?")) return;
    await db.collection("subjects").doc(currentId).delete();
    $("#editor").style.display="none";
    currentId=null;
    await loadSubjects();
    showToast("ğŸ—‘ï¸ Deleted","#ed3737");
  };
}
</script>
</body>
</html>
