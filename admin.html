
<!DOCTYPE html>
<html lang="ka">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekge Admin ‚Äî University Platform</title>

<!-- SEO META -->
<meta name="description" content="Weekge Admin Panel ‚Äî Manage university syllabus subjects, weeks, slides and videos.">
<meta name="keywords" content="weekge, week, weekge admin, syllabus editor, study admin, ug, university admin">
<meta name="author" content="weekge">
<meta name="theme-color" content="#0B1216">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Saira:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0B1216; --surface:#17333d; --text:#EDEFF2;
  --accent:#0fbe35; --success:#38d98a; --danger:#ED3737;
  --buttontext:#ffffff;
}

/* Scrollbar */
::-webkit-scrollbar{width:.35rem}
::-webkit-scrollbar-thumb{background:#16b438}

/* Base */
*{box-sizing:border-box;margin:0;padding:0;font-family:"Saira",sans-serif;}
body{background:var(--bg);color:var(--text);height:100vh;display:grid;grid-template-rows:64px 1fr;overflow:hidden;}

/* Loading */
#loadingOverlay{position:fixed;inset:0;z-index:9999;background:#0B1216;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .6s ease,visibility .6s ease;}
#loadingOverlay.hidden{opacity:0;visibility:hidden;}
#loadingOverlay .spinner{width:60px;height:60px;border:5px solid rgba(255,255,255,.15);border-top:5px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
#loadingOverlay p{margin-top:16px;opacity:.9}

/* Header */
header{background:var(--surface);display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid #0006;}
header h1{font-size:20px;color:var(--accent);font-weight:700;}
header .right{display:flex;align-items:center;gap:12px;}
header button{background:var(--accent);color:#111;border:none;padding:8px 16px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;border-radius:0;}
header button img{width:18px;height:18px;filter:brightness(0) invert(1);}
#saveStatus{font-weight:700;font-size:14px}
#saveStatus.saving{color:#ffc423}
#saveStatus.saved{color:var(--success)}
#saveStatus.error{color:var(--danger)}

/* Layout (dual scroll) */
main{display:grid;grid-template-columns:320px 1fr;height:calc(100vh - 64px);}
aside{background:#0E161A;border-right:1px solid #0006;display:flex;flex-direction:column;}
#sidebarScroll{flex:1;overflow-y:auto;padding:10px;}
section{overflow-y:auto;height:100%;padding:20px;}

/* Sidebar */
.search{width:100%;padding:10px;border:none;background:#23343B;color:#fff;margin-bottom:10px;}
.subject-item{padding:10px;background:#1A2328;border:1px solid #0006;margin-bottom:8px;cursor:pointer;font-weight:600;}
.subject-item:hover{background:#2A3A40;}
.subject-item.active{background:var(--accent);color:#111;}
.btn-row{display:flex;gap:10px;margin-top:10px;padding:10px;}
.btn-row button{flex:1;padding:10px;background:var(--accent);color:#111;border:none;cursor:pointer;font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px;}
.btn-row button img{width:20px;height:20px}

/* Editor */
#editor{transition:opacity .1s ease, filter .1s ease;}
#editor.fadeout{opacity:0;filter:blur(4px);}
#editor h2{font-size:22px;margin-bottom:10px;color:var(--accent);}
label{display:block;font-weight:700;margin:8px 0 4px;}
input,select{width:100%;padding:10px;border:none;background:#1A2328;color:#fff;font-size:1rem;margin-bottom:8px;}
.week{border:1px solid #0006;background:#121A1F;padding:12px;margin-bottom:14px;}
.week h3{margin-bottom:8px;color:var(--accent);}
.addBtn{background:var(--accent);color:var(--buttontext);border:none;padding:8px 12px;cursor:pointer;margin-top:8px;display:inline-flex;align-items:center;gap:6px;}
.success{background:var(--success);color:#111}
.danger{background:var(--danger);color:#fff}
.status{text-align:center;margin-top:10px;}
.global{border:0;background:#182025;padding:10px;margin:14px 0 20px;}
.global h3{color:var(--success);margin-bottom:6px;}

/* Color palette + rows */
.customBtnRow{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin:6px 0;}
.customBtnRow input[type=text]{flex:1;min-width:140px;background:#23343B;color:#fff;border:none;padding:8px;}
.palette{display:flex;gap:4px;}
.colorCircle{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid #0006;font-size:12px;}
.removeBtn{background:var(--danger);color:#fff;border:none;padding:6px 10px;cursor:pointer;display:flex;align-items:center;gap:6px;}
.removeBtn img{width:14px;height:14px;filter:invert(1);}

/* Popup (Create Subject) */
#addPopup{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:2000;}
#addPopup.active{display:flex;animation:popupIn .18s ease;}
@keyframes popupIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
.popup-box{background:#121A1F;border:1px solid #0006;width:min(92vw,420px);padding:18px 16px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.5);}
.popup-box h3{color:var(--accent);margin-bottom:10px;text-align:center;}
.popup-box .row{display:grid;gap:6px;margin:8px 0;}
.popup-box input{width:100%;padding:10px;border:none;background:#23343B;color:#fff;}
.popup-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}
.popup-actions button{padding:10px;border:none;font-weight:800;cursor:pointer}
.createBtn{background:var(--accent);color:#111}
.cancelBtn{background:#333;color:#fff}

@media(max-width:900px){
  main{grid-template-columns:1fr}
  aside{order:2}
  section{order:1}
}
</style>
</head>
<body>

<!-- Loading -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <p>Loading Weekge Admin...</p>
</div>

<header>
  <h1>Weekge Admin</h1>
  <div class="right">
    <div id="saveStatus" class="saved">üü¢ Saved</div>
    <button id="signinBtn">
      <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/check.svg" style="width:20px ;height: 20px;" alt="">Sign in with Google
    </button>
    <button id="logoutBtn" style="display:none;">
      <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/delete.svg" style="width:20px ;height: 20px;"   alt="">Logout
    </button>
  </div>
</header>

<main>
  <!-- Sidebar (own scroll) -->
  <aside>
    <div id="sidebarScroll">
      <input type="search" id="searchBox" class="search" placeholder="Search subjects...">
      <div id="subjectList"></div>
    </div>
    <div class="btn-row">
      <button id="addSubjectBtn">
        <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" style="width:25px ;height: 25px;" alt="">Add Subject
      </button>
    </div>
  </aside>

  <!-- Editor (own scroll) -->
  <section>
    <h2 id="editorTitle">Select a subject to edit</h2>
    <div id="editor" style="display:none;">
      <label>Subject ID</label>
      <input id="subjectId" disabled>
      <label>Subject Name</label>
      <input id="subjectName">
      <label>Theme Title</label>
      <input id="subjectTheme">

      <div class="global">
        <h3>üåç Global Buttons</h3>
        <div id="globalBtns"></div>
        <button class="addBtn" id="addGlobalBtn">
          <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" alt="" width="18" height="18">Add Global Button
        </button>
      </div>

      <div id="weeksContainer"></div>

      <div class="btn-row" style="padding:0">
        <button class="success" id="saveBtn">
          <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/check.svg" alt="" width="18" height="18">SAVE
        </button>
        <button class="danger" id="deleteBtn">
          <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/delete.svg" alt="" width="18" height="18">DELETE
        </button>
      </div>
      <div class="status" id="status"></div>
    </div>
  </section>
</main>

<!-- Create Subject Popup -->
<div id="addPopup">
  <div class="popup-box">
    <h3>üÜï ·Éê·ÉÆ·Éê·Éö·Éò ·É°·Éê·Éí·Éê·Éú·Éò</h3>
    <div class="row">
      <label for="popupName">·É°·Éê·Éí·Éú·Éò·É° ·É°·Éê·ÉÆ·Éî·Éö·Éò*</label>
      <input id="popupName" placeholder="·Éõ·Éê·Éí: Microeconomics" />
    </div>
    <div class="row">
      <label for="popupId">ID (·Éö·Éê·Éó·Éò·Éú·É£·É†·Éò, ·É£·Éú·Éò·Éô·Éê·Éö·É£·É†·Éò)*</label>
      <input id="popupId" placeholder="·Éõ·Éê·Éí: micro-101" />
    </div>
    <div class="popup-actions">
      <button class="cancelBtn" id="popupCancel">Cancel</button>
      <button class="createBtn" id="popupCreate">Create</button>
    </div>
  </div>
</div>

<script>
const overlay = document.getElementById("loadingOverlay");

fetch("https://raw.githubusercontent.com/WEEKGE/live/main/config.json")
  .then(r => r.json())
  .then(cfg => { firebase.initializeApp(cfg); startAdmin(); })
  .catch(() => document.body.innerHTML = "<h2 style='color:red;text-align:center;margin-top:30vh;'>‚ö†Ô∏è Firebase config not loaded.</h2>");

function startAdmin(){
  const auth = firebase.auth(), db = firebase.firestore();
  let user=null, subjects=[], currentId=null, saveTimer=null;
  const ADMIN_EMAILS=["davit.gvakharia@gmail.com"];
  const $ = s => document.querySelector(s);
  const el=(t,p={},kids=[])=>{const e=document.createElement(t);Object.assign(e,p);kids.forEach(k=>e.append(k));return e;};

  const saveStatus=$("#saveStatus");
  const setSaveState=(st)=>{
    saveStatus.className="";
    if(st==="saving"){saveStatus.textContent="üü† Saving...";saveStatus.classList.add("saving");}
    else if(st==="saved"){saveStatus.textContent="üü¢ Saved";saveStatus.classList.add("saved");}
    else{saveStatus.textContent="‚ùå Error";saveStatus.classList.add("error");}
  };

  function showToast(m,c="#fff"){const s=$("#status");if(s){s.textContent=m;s.style.color=c}}

  /* AUTH */
  const provider=new firebase.auth.GoogleAuthProvider();
  $("#signinBtn").onclick=()=>auth.signInWithPopup(provider);
  $("#logoutBtn").onclick=()=>auth.signOut();

  auth.onAuthStateChanged(async u=>{
    user=u||null;
    if(user){
      $("#signinBtn").style.display="none";$("#logoutBtn").style.display="inline-flex";
      if(ADMIN_EMAILS.includes(user.email)){await loadSubjects();overlay.classList.add("hidden");}
      else overlay.innerHTML="<h1 style='color:red;'>Access Denied</h1>";
    }else{
      overlay.classList.add("hidden");
      $("#signinBtn").style.display="inline-flex";$("#logoutBtn").style.display="none";
    }
  });

  /* DATA */
  async function loadSubjects(){
    const snap=await db.collection("subjects").get();
    subjects=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderList();
  }

  function renderList(){
    const list=$("#subjectList"); list.innerHTML="";
    const q=$("#searchBox").value.toLowerCase();
    subjects
      .filter(s=>s.name?.toLowerCase().includes(q)||s.id?.toLowerCase().includes(q))
      .forEach(s=>{
        const div=el("div",{className:"subject-item",textContent:`${s.name} (${s.id})`});
        div.onclick=()=>openSubject(s.id);
        if(s.id===currentId) div.classList.add("active");
        list.append(div);
      });
  }
  $("#searchBox").oninput=renderList;

  /* CREATE SUBJECT POPUP */
  const popup=$("#addPopup");
  $("#addSubjectBtn").onclick=()=>{ $("#popupName").value=""; $("#popupId").value=""; popup.classList.add("active"); $("#popupName").focus(); };
  $("#popupCancel").onclick=()=>popup.classList.remove("active");
  $("#popupCreate").onclick=createSubject;
  $("#popupId").addEventListener("keydown",e=>{ if(e.key==="Enter") createSubject(); });

  async function createSubject(){
    const name=$("#popupName").value.trim();
    const id=$("#popupId").value.trim();
    if(!name || !id){alert("·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éî ·Éù·É†·Éò·Éï·Éî ·Éï·Éî·Éö·Éò: ·É°·Éê·ÉÆ·Éî·Éö·Éò ·Éì·Éê ID");return;}
    // optional: validate id (latin, -, _)
    const valid=/^[a-z0-9\-_\.]+$/i.test(id);
    if(!valid){alert("ID ·É£·Éú·Éì·Éê ·É®·Éî·Éò·É™·Éê·Éï·Éì·Éî·É° ·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·Éê·É°·Éù·Éî·Éë·É°, ·É™·Éò·É§·É†·Éî·Éë·É°, '-', '_' ·Éê·Éú '.'");return;}

    // prevent overwrite if exists
    const doc=await db.collection("subjects").doc(id).get();
    if(doc.exists){alert("·Éê·Éò·Éì·Éò ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·É£·Éö·Éò·Éê. ·Éê·Éò·É†·É©·Éò·Éî ·É°·ÉÆ·Éï·Éê ID.");return;}

    const payload={
      id,
      name,
      theme:"",
      globalButtons:[],
      weeks:[] // ·É™·Éê·É†·Éò·Éî·Éö·Éò; ·É®·Éî·Éõ·Éì·Éí·Éù·Éõ·É®·Éò ·É®·Éî·Éò·Éï·É°·Éî·Éë·Éê
    };
    await db.collection("subjects").doc(id).set(payload);
    popup.classList.remove("active");
    await loadSubjects();
    openSubject(id); // ·Éí·Éê·ÉÆ·É°·Éú·Éê·É° ·Éê·ÉÆ·Éö·Éê·Éì ·É®·Éî·É•·Éõ·Éú·Éò·Éö·Éò
    showToast("‚úÖ Subject created", "#38d98a");
  }

  /* FADE TRANSITION */
  function fadeEditor(cb){
    const ed=$("#editor");
    ed.classList.add("fadeout");
    setTimeout(()=>{ cb(); ed.classList.remove("fadeout"); }, 100);
  }

  /* OPEN SUBJECT */
  async function openSubject(id){
    const doc=await db.collection("subjects").doc(id).get();
    if(!doc.exists) return alert("Not found");
    const data=doc.data();
    currentId=id;

    // highlight active in list
    document.querySelectorAll(".subject-item").forEach(x=>x.classList.toggle("active", x.textContent.endsWith(`(${id})`)));

    $("#editor").style.display="block";
    fadeEditor(()=>{
      $("#editorTitle").textContent=`Editing: ${data.name}`;
      $("#subjectId").value=id;
      $("#subjectName").value=data.name||"";
      $("#subjectTheme").value=data.theme||"";
      renderGlobal(data.globalButtons||[]);
      renderWeeks(data.weeks||[]);
    });
  }

  /* RENDER GLOBAL BUTTONS */
  function renderGlobal(btns){
    const box=$("#globalBtns"); box.innerHTML="";
    btns.forEach((b, idx)=> box.append(createButtonEditor(b)));
    $("#addGlobalBtn").onclick=()=>{
      box.append(createButtonEditor({label:"New", link:"", color:"#ffc423", textColor:"#111"}));
      autoSave();
    };
    // delegate input events for autosave
    box.oninput=autoSave;
    box.onclick=(e)=>{ if(e.target.closest(".removeBtn")) autoSave(); };
  }

  /* RENDER WEEKS + STANDARD BUTTONS (Slide/Video/Custom) */
  function renderWeeks(weeks){
    const box=$("#weeksContainer"); box.innerHTML="";
    for(let i=1;i<=12;i++){
      const w=weeks.find(x=>x.week===i)||{};
      const div=el("div",{className:"week"});
      div.innerHTML=`
        <h3>Week ${i}</h3>
        <label>Topic Title</label>
        <input id="topic-${i}" type="text" value="${w.topic||""}" placeholder="e.g. Microeconomics Basics">

        <label>Type</label>
        <select id="type-${i}">
          <option value="·Éö·Éî·É•·É™·Éò·Éê"${w.type==="·Éö·Éî·É•·É™·Éò·Éê"?" selected":""}>·Éö·Éî·É•·É™·Éò·Éê</option>
          <option value="·Éö·Éî·É•·É™·Éò·Éê (·É•·Éï·Éò·Éñ·Éò)"${w.type==="·Éö·Éî·É•·É™·Éò·Éê (·É•·Éï·Éò·Éñ·Éò)"?" selected":""}>·Éö·Éî·É•·É™·Éò·Éê (·É•·Éï·Éò·Éñ·Éò)</option>
          <option value="·É®·É£·Éê·Éö·Éî·Éì·É£·É†·Éò"${w.type==="·É®·É£·Éê·Éö·Éî·Éì·É£·É†·Éò"?" selected":""}>·É®·É£·Éê·Éö·Éî·Éì·É£·É†·Éò</option>
        </select>

        <div id="buttons-${i}"></div>

        <div class="weekBtns" id="weekBtns-${i}" style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="addBtn slideBtn" data-week="${i}">
            <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" alt="" width="18" height="18">Add Slide
          </button>
          <button class="addBtn videoBtn" data-week="${i}">
            <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" alt="" width="18" height="18">Add Video
          </button>
          <button class="addBtn addCustom" data-week="${i}">
            <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" alt="" width="18" height="18">Add Custom
          </button>
        </div>
      `;
      box.append(div);

      const btnBox = div.querySelector(`#buttons-${i}`);
      (w.buttons||[]).forEach(b=> btnBox.append(createButtonEditor(b)));

      // hook events for autosave
      div.querySelector(`#topic-${i}`).oninput=autoSave;
      div.querySelector(`#type-${i}`).oninput=autoSave;

      // Add buttons
      div.querySelector(".slideBtn").onclick=()=>{
        const exists=[...btnBox.querySelectorAll(".btnLabel")].some(el=>el.value.toLowerCase()==="slide");
        if(!exists){ btnBox.append(createButtonEditor({label:"Slide",link:"#",color:"#2979ff",textColor:"#fff"})); updateAddButtonsVisibility(i); autoSave(); }
      };
      div.querySelector(".videoBtn").onclick=()=>{
        const exists=[...btnBox.querySelectorAll(".btnLabel")].some(el=>el.value.toLowerCase()==="video");
        if(!exists){ btnBox.append(createButtonEditor({label:"Video",link:"#",color:"#ed3737",textColor:"#fff"})); updateAddButtonsVisibility(i); autoSave(); }
      };
      div.querySelector(".addCustom").onclick=()=>{
        btnBox.append(createButtonEditor({label:"New",link:"",color:"#ffc423",textColor:"#111"}));
        autoSave();
      };

      // delegate inside buttons area
      btnBox.oninput=autoSave;
      btnBox.onclick=(e)=>{ if(e.target.closest(".removeBtn")){ updateAddButtonsVisibility(i); autoSave(); } };

      updateAddButtonsVisibility(i);
    }
  }

  function updateAddButtonsVisibility(i){
    const weekBox = document.querySelector(`#buttons-${i}`);
    const slideBtn = document.querySelector(`#weekBtns-${i} .slideBtn`);
    const videoBtn = document.querySelector(`#weekBtns-${i} .videoBtn`);
    const hasSlide = [...weekBox.querySelectorAll(".btnLabel")].some(el=>el.value.toLowerCase()==="slide");
    const hasVideo = [...weekBox.querySelectorAll(".btnLabel")].some(el=>el.value.toLowerCase()==="video");
    slideBtn.style.display = hasSlide ? "none" : "inline-flex";
    videoBtn.style.display = hasVideo ? "none" : "inline-flex";
  }

  /* Color options */
  const COLOR_PALETTE=[
    { bg:"#ffc423", text:"#111" },
    { bg:"#38d98a", text:"#111" },
    { bg:"#ed3737", text:"#fff" },
    { bg:"#2979ff", text:"#fff" }
  ];

  function createButtonEditor(b){
    const wrap=el("div",{className:"customBtnRow"});
    wrap.innerHTML=`
      <input class="btnLabel" type="text" value="${b.label||""}" placeholder="Name">
      <input class="btnLink" type="text" value="${b.link||""}" placeholder="Link">
      <div class="palette">
        ${COLOR_PALETTE.map(col=>`
          <div class="colorCircle" data-bg="${col.bg}" data-text="${col.text}" style="background:${col.bg};color:${col.text}">
            ${b.color===col.bg ? "‚úì" : ""}
          </div>`).join("")}
      </div>
      <button class="removeBtn">
        <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/delete.svg" alt="">Remove
      </button>
    `;
    wrap.dataset.color=b.color||"#ffc423";
    wrap.dataset.textColor=b.textColor||"#111";

    wrap.querySelectorAll(".colorCircle").forEach(c=>{
      c.onclick=()=>{
        wrap.dataset.color=c.dataset.bg;
        wrap.dataset.textColor=c.dataset.text;
        wrap.querySelectorAll(".colorCircle").forEach(x=>x.textContent="");
        c.textContent="‚úì";
        autoSave();
      };
    });

    wrap.querySelector(".removeBtn").onclick=()=>{ wrap.remove(); };
    return wrap;
  }

  /* AUTOSAVE (debounced) */
  async function autoSave(){
    if(!currentId) return;
    clearTimeout(saveTimer);
    setSaveState("saving");
    saveTimer=setTimeout(async()=>{
      try{
        // collect global buttons
        const globalBtns=[...document.querySelectorAll("#globalBtns .customBtnRow")].map(b=>({
          label:b.querySelector(".btnLabel").value,
          link:b.querySelector(".btnLink").value,
          color:b.dataset.color,
          textColor:b.dataset.textColor
        }));

        // collect weeks
        const weeks=[];
        for(let i=1;i<=12;i++){
          const weekDiv=document.querySelector("#weeksContainer").children[i-1];
          if(!weekDiv) continue;
          const topic=(document.querySelector("#topic-"+i)?.value||"").trim();
          const type=(document.querySelector("#type-"+i)?.value)||"·Éö·Éî·É•·É™·Éò·Éê";
          const buttons=[...weekDiv.querySelectorAll(".customBtnRow")].map(b=>({
            label:b.querySelector(".btnLabel").value,
            link:b.querySelector(".btnLink").value,
            color:b.dataset.color,
            textColor:b.dataset.textColor
          }));
          const w={week:i,type,buttons};
          if(topic) w.topic=topic;
          weeks.push(w);
        }

        const name=$("#subjectName").value.trim();
        const theme=$("#subjectTheme").value.trim();
        await db.collection("subjects").doc(currentId).set({ id:currentId, name, theme, globalButtons:globalBtns, weeks }, { merge:true });
        setSaveState("saved");
      }catch(e){
        console.error(e);
        setSaveState("error");
      }
    },1200);
  }

  // top-level fields autosave
  $("#subjectName").oninput=autoSave;
  $("#subjectTheme").oninput=autoSave;

  // manual save/delete
  $("#saveBtn").onclick=autoSave;
  $("#deleteBtn").onclick=async()=>{
    if(!currentId || !confirm("Delete this subject?")) return;
    await db.collection("subjects").doc(currentId).delete();
    $("#editor").style.display="none";
    currentId=null;
    await loadSubjects();
    showToast("üóëÔ∏è Deleted","#ed3737");
  };
}
</script>
</body>
</html>
