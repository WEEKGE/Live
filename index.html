<!DOCTYPE html>
<html lang="ka">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Weekge â€” University Syllabus Platform</title>

  <meta name="description" content="Weekge (Week.ge) â€” áƒ£áƒœáƒ˜áƒ•áƒ”áƒ áƒ¡áƒ˜áƒ¢áƒ”áƒ¢áƒ˜áƒ¡ áƒ¡áƒáƒ’áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ“áƒ áƒ¡áƒ˜áƒšáƒáƒ‘áƒ£áƒ¡áƒ”áƒ‘áƒ˜áƒ¡ áƒáƒšáƒáƒ¢áƒ¤áƒáƒ áƒ›áƒ. áƒœáƒáƒ®áƒ” áƒ¨áƒ”áƒœáƒ˜ áƒ¡áƒáƒ’áƒœáƒ”áƒ‘áƒ˜ áƒ™áƒ•áƒ˜áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒ˜áƒ®áƒ”áƒ“áƒ•áƒ˜áƒ— áƒ“áƒ áƒ˜áƒáƒšáƒ˜ áƒœáƒáƒ•áƒ˜áƒ’áƒáƒªáƒ˜áƒ˜áƒ—.">
  <meta name="theme-color" content="#0B1216">
  <link rel="icon" href="https://raw.githubusercontent.com/WEEKGE/live/refs/heads/main/logo/weekge%20logo.png">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@100..900&display=swap');

  :root {
    --bg: #0B1216;
    --top: #1C2A2F;
    --card: #2A3A40;
    --line: #83919922;
    --text: #EDEFF2;
    --muted: #B7C0C6;
    --accent: #ffbb00;
    --done: #1ae63c;
    --pending: #5c5c5c;
    --danger: #ED3737;
    --subject-title: #7cff7c;
    --shadow: 0 8px 28px rgba(0, 0, 0, .35);
    --defcolor: #16b438;
    --dot: #ffffff;
    --remove: #c72626;
  }

  * { box-sizing: border-box; }
  html, body {
    overflow-y: hidden;
    height: 100%;
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: "Noto Sans Georgian", sans-serif;
  }

  ::-webkit-scrollbar { width: .3rem }
  ::-webkit-scrollbar-thumb { background: var(--defcolor); border-radius: 0px }

  /* === Loading Overlay === */
  #loadingOverlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: #0B1216;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity .3s ease, visibility .3s ease;
  }
  #loadingOverlay.hidden {
    opacity: 0;
    visibility: hidden;
  }
  #loadingOverlay .spinner {
    width: 100px;
    height: 100px;
    border: 10px solid rgba(255,255,255,.15);
    border-top: 10px solid var(--defcolor);
    border-radius: 50%;
    animation: spin 0.3s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loadingOverlay p {
    margin-top: 16px;
    opacity: .9;
  }

  /* NAV */
  .nav {
    position: sticky;
    top: 0;
    z-index: 50;
    height: 64px;
    background: var(--top);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    border-bottom: 1px solid rgba(1, 255, 13, 0.4);
  }

  .brand { display: flex; align-items: center; gap: 10px; font-weight: 500; }
  .week-toggle {
    background: transparent; border: none; color: var(--text);
    font-size: 1rem; cursor: pointer; border-radius: 0;
  }

  .today-btn {
    background: var(--accent); color: #000; border: none;
    padding: 8px 14px; border-radius: 10px; font-weight: 700; cursor: pointer;
  }

  .signin-btn {
    background: #fff; color: #0B1216; border: none;
    padding: 10px 14px; border-radius: 999px; cursor: pointer;
  }

  .avatar {
    width: 42px; height: 42px; border-radius: 0; border: 0;
    cursor: pointer; object-fit: cover; display: none; box-shadow: var(--shadow);
  }

  /* MENU */
  .menu {
    position: absolute; right: 16px; top: 64px;
    width: 220px; background: rgba(43,47,49,.9); backdrop-filter: blur(12px);
    box-shadow: var(--shadow); transform: translateY(-10px) scale(1);filter: blur(5px);
    opacity: 0; pointer-events: none; transition: opacity .25s, transform .25s;
    display: flex; flex-direction: column; align-items: center; text-align: center;
  }
  .menu.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; filter: blur(0)}

    .menu a, .menu button {
      width: 100%;
      background: transparent;
      color: #fff;
      border: 0;
      padding: 20px 15px;
      display: flex;              /* âœ… áƒªáƒ”áƒœáƒ¢áƒ áƒ¨áƒ˜ áƒ›áƒáƒ¡áƒáƒ§áƒ•áƒáƒœáƒáƒ“ */
      align-items: center;        /* áƒ•áƒ”áƒ áƒ¢áƒ˜áƒ™áƒáƒšáƒ£áƒ áƒáƒ“ */
      justify-content: center;    /* áƒ°áƒáƒ áƒ˜áƒ–áƒáƒœáƒ¢áƒáƒšáƒ£áƒ áƒáƒ“ */
      font-size: 1.1rem;
      cursor: pointer;
      transition: 0.2s ease;
      font-weight: bold;
    }

  .menu a:hover, .menu button:hover { background: rgba(255,255,255,0.1); }
  .menu .sep { height: 1px; width: 100%; background: #FFFFFF22;}



  /* LAYOUT */
  .wrap {
    height: calc(100% - 64px);
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 18px;
  }
  .left {
    border-right: 1px solid var(--line);
    padding: 10px 15px;
    overflow: auto;
    background: #0e161a;
    transition: transform .3s ease;
  }
  .right-panel { overflow: auto; }

  /* WEEKS LIST */
  .week-item {
    display: grid; grid-template-columns: 50px 1fr;
    align-items: center; gap: 10px; padding: 18px 8px;
    border-radius: 0; cursor: pointer;
  }
  .week-item.active { background: #1a2328; }
  .dot {
    width: 34px; height: 34px; border-radius: 0;
    border: 5px solid var(--dot); background: var(--pending);
  }
  .dot.current { background: var(--accent); }
  .dot.done { background: var(--done); }

  .wk-title { font-weight: 500; margin-bottom: .2rem; }
  .wk-dates { font-size: 13px; color: var(--muted); }

  /* CARDS */
  #cardsCanvas { transition: opacity .35s ease, filter .35s ease; }
  .card-stack {
    display: flex; flex-direction: column; gap: 20px;
    max-width: 1300px; min-width: 1000px; margin: 0 auto; padding: 20px;
  }
  .card {
    background: var(--card); border-radius: 0; box-shadow: var(--shadow);
    padding: 25px; border: 0px solid #0005;
    display: flex; flex-direction: column; gap: 16px;
  }
  .subhead { text-align: center; font-weight: 700; opacity: .9; margin-bottom: 4px; font-size: 1.4rem;}
  .card-sections { display: flex; justify-content: space-between; align-items: stretch; gap: 16px; }
  .card-section {
    flex: 1; background: #00000018; border: 1px solid rgba(255,255,255,.13);
    border-radius: 0; padding: 16px; display: flex; flex-direction: column;
    justify-content: space-between; transition: transform .2s, background .2s;
  }
  .card-section:hover { background: #ffffff05; }
  .card-section h4 { margin: 0 0 30px; font-weight: 300; color: var(--subject-title); font-size: 1.2rem; border-bottom: #ffffff56 solid 1px; padding-bottom: 10px;}

  .global-files {
    background: #00000018;
    border: 1px solid rgba(255,255,255,.13);
    padding: 14px 16px;
  }
  .global-files h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: var(--subject-title);
    font-weight: 300;
    font-size: 1.2rem;
    border-bottom: #ffffff56 solid 1px; 
    padding-bottom: 10px;
  }

  .btns { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
  .pill {
    border: none; border-radius: 0px; padding: 10px 20px;
    font-weight: 500; cursor: pointer; font-size: 1.1rem; width: 100%;
    transition: ease 0.1s;
  }

  .pill:hover{filter:brightness(1.1)}

  .empty { opacity: .75; text-align: center; margin-top: 14vh; }

  /* MODAL */
  .modal{position:fixed;inset:0;z-index:200;background:rgba(11,18,22,.75);backdrop-filter:blur(12px);
    display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:.35s;}
  .modal.open{opacity:1;pointer-events:auto;}
  .modal-inner{background:#121A1F;width:96%;max-width:1100px;height:92vh;box-shadow:0 8px 40px rgba(0,0,0,.4);
    transform:scale(.9);opacity:0;transition:.35s cubic-bezier(.22,1,.36,1);display:flex;flex-direction:column;overflow:hidden;}
  .modal.open .modal-inner{transform:scale(1);opacity:1;}
  .modal-head{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:#1C2A2F;border-bottom:1px solid #0005;}
  .close{background:0;color:#fff;border:0;padding:4px 8px;font-weight:700;cursor:pointer;font-size:1rem;}
  .modal-body{flex:1;overflow-y:auto;display:flex;flex-direction:column;padding-bottom:20px;}
  .catalog{flex:1;display:grid;grid-template-columns:minmax(0,1fr) minmax(350px,400px);gap:14px;padding:16px 20px;}
  .list,.sidebox{background:hsl(200,30%,7%);padding:10px;overflow:auto;}
  .search-box{background:#23343b;border:0;padding:10px 12px;color:var(--text);width:100%;margin-bottom:10px;font-size:1rem;outline:none;}
  #mySubjects{max-height:55vh;overflow-y:auto;}
  .item {
  display: flex;
  flex-direction: column; /* ğŸ‘ˆ áƒ”áƒ¡ áƒ“áƒáƒ•áƒáƒ›áƒáƒ¢áƒ”áƒ—, áƒ áƒáƒ—áƒ áƒ”áƒšáƒ”áƒ›áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜ áƒ¥áƒ•áƒ”áƒ›áƒáƒ— áƒ˜áƒ§áƒáƒ¡ áƒ”áƒ áƒ—áƒ›áƒáƒœáƒ”áƒ—áƒ˜áƒ¡ áƒ¥áƒ•áƒ”áƒ¨ */
  align-items: flex-start;
  gap: 6px;
  padding: 8px 6px;
  border-bottom: 1px solid #fff1;
  flex-wrap: wrap;
}

.item div:first-child {
  width: 100%;
}

/* áƒ§áƒ•áƒ”áƒšáƒ áƒ¦áƒ˜áƒšáƒáƒ™áƒ˜ */
.item button {
  background: #2e3a40;
  border: 0;
  color: #fff;
  padding: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0;
  width: 36px;
  height: 36px;
  margin-top: 4px;
  transition: background 0.25s ease, transform 0.15s ease;
}

.item button:hover {
  background: #213035;
}

.day-select {
  background: #23343b;
  color: #fff;
  padding: 15px;
  border-radius: 0;
  font-size: 1rem;
  width: 100%;
  margin-top: 6px;
  border: 0;
}

.item .added {
  background: var(--defcolor) !important; /* áƒ›áƒ¬áƒ•áƒáƒœáƒ” áƒ¤áƒáƒœáƒ–áƒ” */
  color: #fff !important;          /* áƒ—áƒ”áƒ—áƒ áƒ˜ áƒáƒ˜áƒ¥áƒáƒœáƒ˜ */
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  transition: background 0.2s ease;
}

.item .added:hover {
  background: #1a7017 !important;  /* hover-áƒ–áƒ” áƒáƒ“áƒœáƒáƒ• áƒ›áƒ£áƒ¥áƒ˜ áƒ›áƒ¬áƒ•áƒáƒœáƒ” */
}


  .save{width:100%;margin-top:10px;background:#38D98A;color:#111;border:none;padding:15px 10px;font-weight:700;cursor:pointer;font-size:1rem;}


  .topic-text {
  white-space: pre-wrap;         /* áƒáƒ®áƒ¡áƒ”áƒœáƒ”áƒ‘áƒ¡ áƒ’áƒáƒ›áƒáƒ¢áƒáƒ•áƒ”áƒ‘áƒ”áƒ‘áƒ¡ áƒ“áƒ Enter-áƒ”áƒ‘áƒ¡ */
  word-wrap: break-word;         /* áƒáƒ«áƒšáƒ”áƒ•áƒ¡ áƒ’áƒ áƒ«áƒ”áƒšáƒ˜ áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒ“áƒáƒ¢áƒáƒœáƒáƒ¡ */
  line-height: 1.5;
  font-size: 1rem;
  color: var(--text);
  }
  .topic-text b {
    font-weight: 700;
  }
  .topic-text i {
    font-style: italic;
  }
  .topic-text u {
    text-decoration: underline;
  }




  /* Responsive */
@media(max-width:900px){
  .wrap{grid-template-columns:1fr;}
  .left{
    position:absolute;
    left:0;top:64px;bottom:0;width:100%;
    transform:translateY(-100%);
    z-index:30;
  }
  .left.open{transform:translateY(0);}
  .card-sections{flex-direction:column;}
  .card-stack{width:100%;max-width:100vw;min-width:50px;padding: 0.5rem;}
  .card{padding: 1rem;}
  .card-section{padding: 0.5rem;}
  .card-section h4{font-size: 1rem;}
  .global-files {padding: 0.5rem;}

  /* âœ… Profile Settings layout */
  .catalog{
    grid-template-columns:1fr;
    grid-template-rows:auto auto;
  }
  .sidebox{
    order:1;
    margin-bottom:15px;
    height: calc(100vh - 200px); /* áƒ–áƒ”áƒ›áƒáƒ“áƒáƒœ-áƒ¥áƒ•áƒ”áƒ›áƒáƒ— áƒ˜áƒ™áƒáƒ•áƒ”áƒ‘áƒ¡ áƒ¡áƒ áƒ£áƒš áƒáƒ“áƒ’áƒ˜áƒšáƒ¡ */
    overflow: visible; /* áƒáƒ¦áƒáƒ  áƒ¡áƒ¥áƒ áƒáƒšáƒáƒ•áƒ¡ */
  }
  #mySubjects{
    max-height: none; /* full height */
    overflow: visible;
  }
  .list{
    order:2;
  }

  .item {
    flex-direction: column;
    align-items: flex-start;
  }
  .item div:first-child {
    width: 100%;
  }
  .item button {
    align-self: flex-end;
    width: 36px;
    height: 36px;
    margin-top: 4px;
  }
  .day-select {
    width: 100%;
    margin-top: 6px;
  }
}


  @media(min-width:901px){
    #weekToggle,#todayBtn{display:none!important;pointer-events:none;}
  }
</style>
</head>

<body>
<!-- âœ… Loading Overlay -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <p>áƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ</p>
</div>

<div class="nav">
  <div class="brand">
    <button id="weekToggle" class="week-toggle">ğŸ“… Week â€”</button>
    <button id="todayBtn" class="today-btn">Today</button>
  </div>
  <div class="right">
    <button id="signinBtn" class="signin-btn">Sign in with Google</button>
    <img id="avatar" class="avatar" src="" alt="profile" />
    <div id="menu" class="menu">
      <button id="openProfile">áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜</button>
      <button id="logoutBtn">áƒ’áƒáƒ¡áƒ•áƒšáƒ</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div id="weeksList" class="left"></div>
  <div class="right-panel">
    <div id="cardsCanvas" class="card-stack">
      <div class="empty">áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒáƒ’áƒœáƒ”áƒ‘áƒ˜ áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ¨áƒ˜-áƒ¨áƒ˜.</div>
    </div>
  </div>
</div>

<!-- âœ… Profile Settings -->
<div id="modal" class="modal">
  <div class="modal-inner">
    <div class="modal-head">
      <div>Profile Settings</div>
      <button id="closeModal" class="close">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="catalog">
        
        <!-- áƒ©áƒ”áƒ›áƒ˜ áƒ¡áƒáƒ’áƒœáƒ”áƒ‘áƒ˜ -->
        <div class="sidebox">
          <div style="margin-bottom:6px;font-weight:700;">áƒ©áƒ”áƒ›áƒ˜ áƒ¡áƒáƒ’áƒœáƒ”áƒ‘áƒ˜</div>
          <div id="mySubjects"></div>
          <button id="saveSubjects" class="save">Save</button>
        </div>

        <!-- áƒ™áƒáƒ¢áƒáƒšáƒáƒ’áƒ˜ -->
        <div class="list">
          <input type="text" id="searchCatalog" class="search-box" placeholder="áƒ›áƒáƒ«áƒ”áƒ‘áƒœáƒ” áƒ¡áƒáƒ’áƒáƒœáƒ˜">
          <div id="catalogList"><div class="empty">áƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ...</div></div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>



<!-- JS -->
<script>
const overlay = document.getElementById("loadingOverlay");

fetch("https://raw.githubusercontent.com/WEEKGE/live/main/config.json")
.then(r => r.json())
.then(cfg => {
  firebase.initializeApp(cfg);
  startWeekge();
})
.catch(() => {
  overlay.innerHTML = "<h2 style='color:red;text-align:center;margin-top:30vh;'>âš ï¸ config.json áƒ•áƒ”áƒ  áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ.</h2>";
});

function startWeekge(){
  const auth = firebase.auth(), db = firebase.firestore();
  let user=null,catalog=[],selected=[],cache={},weekDates=[],userDays={};
  const $=s=>document.querySelector(s);
  const el=(t,p={},kids=[])=>{const e=document.createElement(t);Object.assign(e,p);kids.forEach(k=>e.append(k));return e;};
  const todayISO=()=>new Date().toISOString().slice(0,10);
  const isBetween=(d,s,e)=>d>=s&&d<=e;
  const hasPassed=(d,e)=>d>e;
  const fmtRange=(s,e)=>{const f=d=>new Date(d+"T12:00:00").toLocaleString(undefined,{month:"short",day:"numeric"});return f(s)+" â†’ "+f(e);};

  const SEMESTER_WEEKS=[
    {n:1,start1:"2025-09-22",end1:"2025-09-28",start2:"2026-03-02",end2:"2026-03-08"},
    {n:2,start1:"2025-09-29",end1:"2025-10-05",start2:"2026-03-09",end2:"2026-03-15"},
    {n:3,start1:"2025-10-06",end1:"2025-10-12",start2:"2026-03-16",end2:"2026-03-22"},
    {n:4,start1:"2025-10-13",end1:"2025-10-19",start2:"2026-03-23",end2:"2026-03-29"},
    {n:5,start1:"2025-10-20",end1:"2025-10-26",start2:"2026-03-30",end2:"2026-04-05"},
    {n:6,start1:"2025-10-27",end1:"2025-11-02",start2:"2026-04-06",end2:"2026-04-12"},
    {n:7,start1:"2025-11-03",end1:"2025-11-09",start2:"2026-04-20",end2:"2026-04-26"},
    {n:8,start1:"2025-11-10",end1:"2025-11-16",start2:"2026-04-27",end2:"2026-05-03"},
    {n:9,start1:"2025-11-17",end1:"2025-11-23",start2:"2026-05-04",end2:"2026-05-10"},
    {n:10,start1:"2025-11-24",end1:"2025-11-30",start2:"2026-05-11",end2:"2026-05-17"},
    {n:11,start1:"2025-12-01",end1:"2025-12-07",start2:"2026-05-18",end2:"2026-05-24"},
    {n:12,start1:"2025-12-08",end1:"2025-12-14",start2:"2026-05-25",end2:"2026-05-31"}
  ];

  const colorMap = {
    yellow: ["#ffc423", "#000"],
    green:  ["#38d98a", "#fff"],
    red:    ["#ed3737", "#fff"],
    blue:   ["#2979ff", "#fff"]
  };

  const daysOfWeek = ["áƒáƒ áƒ¨áƒáƒ‘áƒáƒ—áƒ˜","áƒ¡áƒáƒ›áƒ¨áƒáƒ‘áƒáƒ—áƒ˜","áƒáƒ—áƒ®áƒ¨áƒáƒ‘áƒáƒ—áƒ˜","áƒ®áƒ£áƒ—áƒ¨áƒáƒ‘áƒáƒ—áƒ˜","áƒáƒáƒ áƒáƒ¡áƒ™áƒ”áƒ•áƒ˜","áƒ¨áƒáƒ‘áƒáƒ—áƒ˜","áƒ™áƒ•áƒ˜áƒ áƒ"];

  $("#weekToggle").onclick=()=>toggleWeeks();

  /* === âœ… Sign In / Sign Out === */
  const provider = new firebase.auth.GoogleAuthProvider();
  $("#signinBtn").onclick = async () => {
    overlay.querySelector("p").textContent = "áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ áƒ›áƒ˜áƒ›áƒ“áƒ˜áƒœáƒáƒ áƒ”áƒáƒ‘áƒ¡...";
    overlay.classList.remove("hidden");
    try {
      await auth.signInWithPopup(provider);
    } catch (err) {
      console.error("Sign-in error:", err);
      alert("âŒ áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ˜áƒ¡áƒáƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒáƒ");
      overlay.classList.add("hidden");
    }
  };

  $("#logoutBtn").onclick = async () => {
    overlay.querySelector("p").textContent = "áƒ’áƒáƒ¡áƒ•áƒšáƒ...";
    overlay.classList.remove("hidden");
    try {
      await auth.signOut();
    } catch (err) {
      console.error("Logout error:", err);
      alert("âŒ áƒ’áƒáƒ¡áƒ•áƒšáƒ˜áƒ¡áƒáƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒáƒ");
      overlay.classList.add("hidden");
    }
  };

  $("#avatar").onclick = () => $("#menu").classList.toggle("open");
  document.addEventListener("click", e => {
    if (!e.target.closest(".avatar") && !e.target.closest(".menu"))
      $("#menu").classList.remove("open");
  });

  $("#openProfile").onclick = async () => {
    $("#menu").classList.remove("open");
    $("#modal").classList.add("open");
    if (!catalog.length) await loadCatalog();
    renderProfile();
  };
  $("#closeModal").onclick = () => $("#modal").classList.remove("open");
  document.addEventListener("keydown", e => {
    if (e.key === "Escape") $("#modal").classList.remove("open");
  });

  /* === AUTH STATE === */
  auth.onAuthStateChanged(async u => {
    user = u || null;
    guardUI(!!user);

    if (user) {
      $("#avatar").src = user.photoURL || "https://i.pravatar.cc/100";
      overlay.querySelector("p").textContent = "áƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ...";
      await bootAfterLogin();

      setTimeout(() => overlay.classList.add("hidden"), 800);
    } else {
      setTimeout(() => overlay.classList.add("hidden"), 800);
    }
  });

  function guardUI(signed) {
    $("#signinBtn").style.display = signed ? "none" : "inline-flex";
    $("#logoutBtn").style.display = signed ? "inline-flex" : "none";
    $("#avatar").style.display = signed ? "block" : "none";
    if (!signed)
      $("#cardsCanvas").innerHTML =
        "<div class='empty'>áƒ¨áƒ”áƒ“áƒ˜ Google-áƒ˜áƒ— áƒ áƒáƒ› áƒœáƒáƒ®áƒ áƒ¡áƒáƒ’áƒœáƒ”áƒ‘áƒ˜.</div>";
  }

  async function loadCatalog() {
    catalog = [];
    const snap = await db.collection("subjects").get();
    snap.forEach(d => catalog.push({ id: d.id, ...d.data() }));
  }

  async function loadUserSelection() {
    const snap = await db.collection("users").doc(user.uid).get();
    const data = snap.exists ? snap.data() : {};
    selected = data.subjects || [];
    userDays = data.days || {};
  }

  async function ensureSubjectsLoaded() {
    const toLoad = selected.filter(id => !cache[id]);
    for (const id of toLoad) {
      const subj = catalog.find(c => c.id === id);
      if (subj) cache[id] = subj;
    }
  }

  function flattenWeeks() {
    weekDates = [];
    SEMESTER_WEEKS.forEach(w => {
      if (w.start1) weekDates.push({ n: w.n, start: w.start1, end: w.end1 });
      if (w.start2) weekDates.push({ n: w.n, start: w.start2, end: w.end2 });
    });
  }

  async function bootAfterLogin() {
    await Promise.all([loadCatalog(), loadUserSelection()]);
    await ensureSubjectsLoaded();
    flattenWeeks();
    paintWeeks();
    goToday();
  }

  function paintWeeks() {
    const iso = todayISO();
    const list = $("#weeksList");
    list.innerHTML = "";
    let activeWeekN = null;
    for (const w of SEMESTER_WEEKS) {
      if (isBetween(iso, w.start1, w.end1) || isBetween(iso, w.start2, w.end2)) {
        activeWeekN = w.n;
        break;
      }
    }

    SEMESTER_WEEKS.forEach(w => {
      const isCurrent = activeWeekN === w.n;
      const done = hasPassed(iso, w.end1) && hasPassed(iso, w.end2);
      const status = isCurrent ? "current" : done ? "done" : "pending";
      const row = el("div", {
        className: `week-item${isCurrent ? " active" : ""}`
      });
      row.setAttribute("data-week", w.n);
      row.append(
        el("div", { className: "dot " + status }),
        el("div", {}, [
          el("div", { className: "wk-title", textContent: `áƒ™áƒ•áƒ˜áƒ áƒ ${w.n}` }),
          el("div", {
            className: "wk-dates",
            textContent:
              fmtRange(w.start1, w.end1) + " / " + fmtRange(w.start2, w.end2)
          })
        ])
      );
      row.onclick = () => {
        document.querySelectorAll(".week-item").forEach(x => x.classList.remove("active"));
        row.classList.add("active");
        showWeek(w.n);
        toggleWeeks(false);
        updateWeekLabel(w.n);
      };
      list.append(row);
    });
    updateWeekLabel(activeWeekN);
  }

  function updateWeekLabel(n) {
    $("#weekToggle").textContent = `áƒ™áƒ•áƒ˜áƒ áƒ ${n || "-"} â–¼`;
  }

  function addBtns(wrap, weekObj) {
    const btns = el("div", { className: "btns" });
    const add = (label, url, colorName) => {
      const [bg, txt] = colorMap[colorName] || ["#38d98a", "#fff"];
      const b = el("button", {
        className: "pill",
        textContent: label,
        style: `background:${bg};color:${txt}`
      });
      if (url) b.onclick = () => window.open(url, "_blank");
      btns.append(b);
    };
    (weekObj.buttons || []).forEach(b =>
      add(b.label, b.link, b.colorName || b.color || "green")
    );
    wrap.append(btns);
  }

  function addGlobalBtns(card, subj) {
    if (subj.globalButtons && subj.globalButtons.length > 0) {
      const box = el("div", { className: "global-files" });
      box.append(el("h4", { textContent: "áƒ›áƒ—áƒáƒ•áƒáƒ áƒ˜ áƒ¤áƒáƒ˜áƒšáƒ”áƒ‘áƒ˜:" }));
      const btns = el("div", { className: "btns" });
      subj.globalButtons.forEach(b => {
        const [bg, txt] = colorMap[b.colorName || b.color] || ["#38d98a", "#fff"];
        const btn = el("button", {
          className: "pill",
          textContent: b.label,
          style: `background:${bg};color:${txt}`
        });
        if (b.link) btn.onclick = () => window.open(b.link, "_blank");
        btns.append(btn);
      });
      box.append(btns);
      card.append(box);
    }
  }

  function todayDayIndex() {
    return new Date().getDay();
  }

  function sortByDayProximity(subjs) {
    const t = todayDayIndex();
    return subjs.sort((a, b) => {
      const da = (a.dayIndex ?? 7) - t;
      const db = (b.dayIndex ?? 7) - t;
      const wrapA = da < 0 ? da + 7 : da;
      const wrapB = db < 0 ? db + 7 : db;
      return wrapA - wrapB;
    });
  }

  function showWeek(n) {
    const canvas = $("#cardsCanvas");
    canvas.style.opacity = "0";
    canvas.style.filter = "blur(8px)";
    setTimeout(() => {
      const stack = el("div", { className: "card-stack" });
      let any = false;
      const subs = sortByDayProximity(selected.map(id => {
        const subj = cache[id];
        if (!subj) return null;
        const day = userDays?.[id] ?? null;
        return {...subj, dayIndex: daysOfWeek.indexOf(day)};
      }).filter(Boolean));

      subs.forEach(subj => {
        const cur = subj.weeks?.find(w => w.week === n);
        const prev = n > 1 ? subj.weeks?.find(w => w.week === n - 1) : null;
        if (!cur && !prev) return;
        any = true;
        const card = el("div", { className: "card" });
        card.append(el("div", { className: "subhead", textContent: subj.name + (userDays?.[subj.id] ? ` (${userDays[subj.id]})` : "") }));

        const typeText = cur?.type || prev?.type || null;
        if (typeText) {
          const typeEl = el("div", {
            style:"text-align:center;font-size:1.1rem;opacity:0.8;margin-top:-6px;",
            textContent: typeText
          });
          card.append(typeEl);
        }

        addGlobalBtns(card, subj);
        const wrap = el("div", { className: "card-sections" });

        if (prev) {
          const sec = el("div", { className: "card-section" });
          sec.append(el("h4", { textContent: "áƒáƒ› áƒ™áƒ•áƒ˜áƒ áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡:" }));
          if (prev.topic)
            sec.append(el("div", { className: "topic-text", style: "margin-bottom:15px;", innerHTML: prev.topic }));
          addBtns(sec, prev);
          wrap.append(sec);
        }

        if (cur) {
          const sec = el("div", { className: "card-section" });
          sec.append(el("h4", { textContent: "áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’áƒ˜ áƒ™áƒ•áƒ˜áƒ áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡:" }));
          if (cur.topic)
            sec.append(el("div", { className: "topic-text", style: "margin-bottom:15px;", innerHTML: cur.topic }));
          addBtns(sec, cur);
          wrap.append(sec);
        }

        card.append(wrap);
        stack.append(card);
      });
      canvas.innerHTML = "";
      canvas.append(any ? stack : el("div", { className: "empty", textContent: "áƒ¡áƒáƒ’áƒœáƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡. áƒ“áƒáƒáƒ›áƒáƒ¢áƒ” áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ¨áƒ˜" }));
      canvas.style.filter = "blur(0)";
      canvas.style.opacity = "1";
    }, 300);
  }

  function goToday() {
    const iso = todayISO();
    const cur = weekDates.find(w => isBetween(iso, w.start, w.end)) || weekDates[0];
    if (cur) {
      showWeek(cur.n);
      updateWeekLabel(cur.n);
      document.querySelectorAll(".week-item").forEach(x => x.classList.remove("active"));
      const currentEl = document.querySelector(`.week-item[data-week="${cur.n}"]`);
      if (currentEl) currentEl.classList.add("active");
    }
    toggleWeeks(false);
  }

  function toggleWeeks(force) {
    const left = $("#weeksList");
    left.classList.toggle("open", force !== undefined ? force : !left.classList.contains("open"));
  }

  /* === PROFILE === */
  function renderProfile() {
    const list = $("#catalogList");
    list.innerHTML = "";
    const mine = $("#mySubjects");
    mine.innerHTML = "";

    catalog.forEach(x => {
      const added = selected.includes(x.id);
      const row = el("div", { className: "item" });

      const left = el("div", {}, [
        el("div", { textContent: x.name, style: "font-weight:700" }),
        el("div", { textContent: x.id, style: "font-size:12px;opacity:.7" })
      ]);

      const action = added
        ? el("button", { className: "added", style: "background:#38d98a;color:#fff;",
            innerHTML: `<img src='https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/check.svg' style='width:25px;height:25px;filter:brightness(0) invert(1);'>` })
        : el("button", { innerHTML: `<img src='https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg' style='width:25px;height:25px;'>`,
            onclick: async () => {
              if (!selected.includes(x.id)) selected.push(x.id);
              await saveSelection(true);
              renderProfile();
            } });

      row.append(left, action);
      list.append(row);
    });

    selected.forEach(id => {
      const subj = catalog.find(c => c.id === id);
      const row = el("div", { className: "item" });
      const left = el("div", {}, [
        el("div", { textContent: subj ? subj.name : id, style: "font-weight:700" }),
        el("div", { textContent: id, style: "font-size:12px;opacity:.7" })
      ]);

      const delBtn = el("button", {
        innerHTML: `<img src='https://raw.githubusercontent.com/WEEKGE/live/ce772a078446be5972f9c7b9f2ff91b0122c1dad/svgs/close.svg' style='width:22px;height:22px;filter:brightness(0) invert(1);'>`,
        style: "background:var(--remove);color:#fff",  // âœ… just red background
        onclick: async () => {
          selected = selected.filter(s => s !== id);
          delete cache[id];
          await saveSelection(true);
          renderProfile();
        }
      });

      const select = el("select", { className: "day-select" });
      daysOfWeek.forEach(d => {
        const opt = el("option", { textContent: d, value: d });
        if (userDays?.[id] === d) opt.selected = true;
        select.append(opt);
      });
      select.onchange = () => { userDays[id] = select.value; };

      row.append(left, delBtn, select);
      mine.append(row);
    });

    $("#saveSubjects").onclick = async () => {
      await saveSelection(true);
    };
  }

  async function saveSelection(immediate = false) {
    if (!user) return;
    await db.collection("users").doc(user.uid).set({ subjects: selected, days: userDays }, { merge: true });
    if (immediate) {
      await ensureSubjectsLoaded();
      paintWeeks();
      goToday();
    }
  }
}
</script>







</body>
</html>
